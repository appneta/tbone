/*! tbone 0.3.4 2014-01-20 */

!function(){function a(a){return a}function b(){return void 0}function c(a){return"function"==typeof a}function d(a){return"string"==typeof a}function e(a){return"number"==typeof a&&!isNaN(a)}function f(a){return null!==a&&"object"==typeof a&&!g(a)}function g(a){return!!(a&&a.getTimezoneOffset&&a.setUTCFullYear)}function h(a){return!(!a||"function"!=typeof a.query)}function i(a){return"boolean"==typeof a}function j(a){return"[object Array]"===nb.call(a)}function k(){cb&&console.error.apply(console,arguments)}function l(a,b){null==b&&(b=rb),sb.type[a]=rb,sb.context[a]=rb,sb.event[a]=rb}function m(){tb=!0}function n(a){cb&&tb&&console.log("render "+_.times(lc,function(){return"."}).join("")+a.Name)}function o(){if(cb)for(var a=0;a<vb.length;a++)vb[a].apply(this,arguments)}function p(a,b,c,e,f,g){var h=d(b)?b:b.Name,i=d(b)?b:b.isModel?"model":b.isView?"view":b.isScope?"scope":"??",j=Math.max(sb.context[h]||0,sb.event[c]||0,sb.type[i]||0)||sb.base;if("lookups"===c&&(e=_.reduce(e,function(a,b){return a[b.obj.Name||"tboneid-"+b.obj.tboneid]=b,a},{})),j>=a){var k=d(e)?_.template(e,f||{}):"",l=!!k||!!e,m=i===h?i:i+" "+h,n=m+" / "+c+(l?": ":""),o=console[a===ob?"error":a===pb?"warn":"log"];o&&o.call&&o.call(console,n,k||e||"",g||"")}}function q(a){vb.push(a)}function r(a){return d(a)||e(a)||g(a)||i(a)?a+"":""}function s(a){var b=[];if(_.each(_.values(a._callbacks||{}),function(a){for(var c=a.next;;){if(!c.context)break;b.push(c.context),c=c.next}}),_.each(_.flatten(_.values(a._events||{})),function(a){a.context&&b.push(a.context)}),h(a)&&c(a))for(var d,e,f,g=[a._events];d=g.pop();)for(f in d)if(""===f){e=d[""];for(var i in e)b.push(e[i])}else g.push(d[f]);return _.uniq(b)}function t(a){for(var b=[a],c=[a];b.length;)for(var d=b.pop(),e=s(d),f=0;f<e.length;f++){var g=e[f];if(g.isScope&&(g=g.context),g){if(g.isView)return!0;g.isModel&&-1===c.indexOf(g)&&(b.push(g),c.push(g))}}return!1}function u(){return(new Date).getTime()}function v(){var a,b,c={stop:function(){b=u()-a},start:function(){a=u()},done:function(){return c.stop(),wb.pop(),wb.length&&wb[wb.length-1].start(),b}};return c.start(),wb.length&&wb[wb.length-1].stop(),wb.push(c),c}function w(a,b,c,d,e,f,g){b||(b=ab?ab.priority-1:0),!d&&ab&&(d=ab.Name+"+");var h=new y(a,c,b,d,e,f);return!g&&ab&&ab.subScopes.push(h),h.execute(),h}function x(a){var b;w(function(){b||a()}),b=!0}function y(a,b,c,d,e,f){_.extend(this,{fn:a,context:b,priority:c,Name:d,onExecuteCb:e,onExecuteContext:f,subScopes:[]})}function z(a){return a.tboneid=a.tboneid||Bb++}function A(){return xb&&(Cb.sort(function(a,b){return a.priority-b.priority}),xb=!1),Cb.pop()}function B(){return!Eb&&!yb}function C(){zb||(zb=setTimeout(function(){pc.query("__isReady__",B()),pc.query("__ajaxReady__",!Eb),pc.query("__numAjaxInFlight__",Eb),zb=null},20))}function D(a){var b=z(a);Db[b]||(Db[b]=!0,Cb.push(a),xb=!0,yb||cb&&Fb||(C(),yb=_.defer(F)))}function E(a){return Gb&&(a?Hb.scrollTop(a):Hb.scrollTop())}function F(){Ab=!1;var a=E();yb=null;for(var b,c=u(),d=5e3;(!cb||!Fb)&&--d&&(b=A());)delete Db[z(b)],b.execute();d||(o(pb,"scheduler","drainQueueOverflow","exceeded max drainQueue iterations"),yb=_.defer(F)),o(rb,"scheduler","drainQueue","ran for <%=duration%>ms",{duration:u()-c}),o(rb,"scheduler","viewRenders","rendered <%=viewRenders%> total",{viewRenders:ub}),C(),a&&!Ab&&a!==E()&&E(a)}function G(){yb&&clearTimeout(yb),F()}function H(){Fb=!0}function I(a,b,c,d,e,i,k){if(i>Sb)return o(pb,a,"recurseLimit","hit recursion depth limit of <%=limit%>",{limit:Sb},{curr:c,prev:d}),!0;b=b||{},c=c,d=d,(h(d)||h(c))&&(k=!0);var l,m,n=k;for(l in b)l===Rb?d!==c&&(f(d)&&f(c)?e=!0:n=g(d)&&g(c)?d.getTime()!==c.getTime()||n:!0):n=I(a,b[l],c&&c[l],d&&d[l],!1,i+1,k)||n;if(e&&!n)if(f(d)&&f(c)){var p={},q=[d,c];for(m=0;2>m&&!n;m++){var r=q[m];if(j(r))for(d.length!==c.length&&(n=!0),l=0;l<r.length&&!n;l++)p[l]||(p[l]=!0,I(a,b[l],c[l],d[l],!0,i+1,!1)&&(n=!0));else for(l in r)if(!p[l]&&(p[l]=!0,I(a,b[l],c[l],d[l],!0,i+1,!1))){n=!0;break}}}else g(d)&&g(c)?n=d.getTime()!==c.getTime():d!==c&&(n=!0);if(n){var s=b[Rb]||{};for(var t in s)s[t].trigger.call(s[t])}return n}function J(a){if(hb.aliasCheck)try{var b=a.attributes;return JSON.stringify(void 0===b?null:b,function(a,b){if(f(b)){var c={};for(var d in b)h(b[d])||(c[d]=b[d]);return c}return b})}catch(c){o(pb,a,"aliascheck","Failed to serialize attributes to JSON")}return"null"}function K(a,b,c){var d={};if(f(b)&&f(a))for(var e={},g=[b,a],h=0;2>h;h++){var i=g[h];for(var j in i)e[j]||(e[j]=!0,_.extend(d,K(b[j],a[j],c.concat(j))))}else b!==a&&(d[c.join(".")]=b+" -> "+a);return d}function L(a,b,c){var d=this,e=a===Ib,g=a===Jb,i=a===Kb,k=a===Lb,l=a===Mb,m=a===Nb,n=a===Ob,p=a===Qb,q=i||k||l||m,r=a===Pb,s=3===arguments.length,t=q||n||r||s||p;"number"!=typeof a&&(c=b,b=a,a=0,2===arguments.length&&(t=!0,s=!0)),b=(b||"").replace("__self__","");var u,v=b.split("."),w=[];for(u=0;u<v.length;u++)v[u]&&w.push(v[u]);for(var x,y,A,B=w[w.length-1]||"attributes",C=d,D=e&&!b?d:d.attributes,E=[],F={},G=t&&d._events.change;;){if(null==D&&!t){E=E.concat(w);break}if(D!==d&&h(D)){A=w.length||(t?!r&&!h(c):!e);break}if(t&&!f(D)&&(w.length||q)){if(r)return;null!=D&&o(pb,this,"mkdir","while writing <%=prop%>, had to overwrite primitive value <%=primitive%> at <%=partial%>",{prop:b,primitive:D,partial:E.join(".")}),D=(w.length?hc.exec(w[0]):q)?[]:{},d.query(E.join("."),D)}if(y=w.shift(),null==y)break;E.push(y),C=D,D=D[y],G&&(_.extend(F,G[Rb]||{}),G=G[y])}if(!t&&bb&&(x=z(d),bb[x]||(bb[x]={obj:d,props:{}}),bb[x].props[E.join(".")]=D),A)return s?D.query(a,w.join("."),c):D.query(a,w.join("."));if(t){if(cb&&d.prevJson&&!b){var H=J(d);if(H!==d.prevJson){var L=JSON.parse(d.prevJson),M=JSON.parse(H),N=K(M,L,[]);o(pb,d,"aliascheck","aliased change detected",{},{before:L,after:M,diffs:N})}}var O;if(i?(cb&&(O=b+"."+D.length),D.push(c)):k?D.unshift(c):l?D.shift(c):m?D.pop(c):r?delete C[B]:n?c=C[B]=!D:p?c=C[B]=(D||0)+c:(C[B]=c,cb&&(O=b)),cb&&h(c)&&(null==c.Name&&(c.Name=O),c.scope&&null==c.scope.Name&&(c.scope.Name="model_"+O)),_.isEmpty(F))I(d,G,D,c,!1,0,!1);else if(I(d,G,D,c,!0,0,!1))for(var P in F)F[P].trigger.call(F[P]);return cb&&(d.prevJson=b?null:J(d)),c}return!g&&d.isCollection&&""===b&&(j(D)?D=_.map(D,function(a){return a.query()}):D&&(D=_.reduce(_.keys(D),function(a,b){return h(D[b])&&(a[b]=D[b].query()),a},{}))),D}function M(a,b){return r(null==b?this.query(a):this.query(a,b))}function N(a){return a.replace(/^change:/,"change.").split(Tb)}function O(a,b,c){var d=Zb[a];_.defaults(c||(c={}),{emulateHTTP:pc.emulateHTTP,emulateJSON:pc.emulateJSON});var e={type:d,dataType:"json"};if(c.url||(e.url=_.result(b,"url")||urlError()),null!=c.data||!b||"create"!==a&&"update"!==a&&"patch"!==a||(e.contentType="application/json",e.data=JSON.stringify(c.attrs||b.toJSON(c))),c.emulateJSON&&(e.contentType="application/x-www-form-urlencoded",e.data=e.data?{model:e.data}:{}),c.emulateHTTP&&("PUT"===d||"DELETE"===d||"PATCH"===d)){e.type="POST",c.emulateJSON&&(e.data._method=d);var f=c.beforeSend;c.beforeSend=function(a){return a.setRequestHeader("X-HTTP-Method-Override",d),f?f.apply(this,arguments):void 0}}"GET"===e.type||c.emulateJSON||(e.processData=!1),"PATCH"!==e.type||!window.ActiveXObject||window.external&&window.external.msActiveXFilteringEnabled||(e.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var g=c.xhr=b.ajax(_.extend(e,c));return g}function P(a,b){return new RegExp(a.replace(/ /g,"[\\s\\n]*"),b)}function Q(a){ic[a]=!0}function R(a,b){return a.replace(gc,function(a,c,d,e){return ic[e]||c||hc.test(e)?a:null!=b[e]?["(",e," && view.isQueryable(",e,") ? ",e,'.query("',d.slice(e.length+1),'")'," : ",d,")"].join(""):["view.query(",Jb,', "',d,'")'].join("")})}function S(a,b){fb[a]=b}function T(a){function b(){d=_.invert(_.flatten(c))}var c=[[]],d={};b();var e=a.replace(cc,function(a,e,f){function g(){var a=R(h.join(""),d);return h=[],a}var h=[],i="@"===e;i&&(e="");var j=f.replace(fc,function(a,d,e){return d.replace(dc,function(a,d,e,f,i,j){return j?(h.push(j),""):(f?c.push([]):d?d.replace(ec,function(a){c[c.length-1].push(a)}):i&&c.pop(),b(),g()+a)})+g()+(e||"")})+g();return"<%"+(i?"= view.getHashId("+j+") ":e?e+"view.denullText("+j+")":j)+"%>"}),f=_.template(e,null,{variable:"view"});return cb&&(f.parsed=e),f}function U(a,b){var c=fb[a];return null!=c||(c=$('script[name="'+a+'"]').html())?("string"==typeof c&&(c=fb[a]=T(c)),c(b)):(k("Could not find template "+a+".  If you don't want to use a template, use the view attribute instead."),"")}function V(a){if(!h(a)){var b=pc.make();b.query("",a),a=b}if(!a.hashId){for(var c=[],d=20;d;d--)c.push(kc.charAt(Math.floor(Math.random()*kc.length)));a.hashId=c.join("")}return jc[a.hashId]=a,a.hashId}function W(a){nc=a}function X(a,b,c){var d={};return _.each(c||[],function(a){(d[a.origOuterHTML]=d[a.origOuterHTML]||[]).push(a)}),_.map(a,function(a){var c=$(a),e=a.outerHTML;if(d[e]&&d[e].length){var f=d[e].shift();return o(rb,b||"render","reuse",f),c.replaceWith(f.el),f}var g={};(c.attr("tbone")||"").replace(oc,function(a,b,c){g[b]=c});var h=g.inline;if(h){var i=c.html().replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&");S(h,i)}var j=h||g.tmpl,l=g.view,m=g.root,n=l||j;n||k("No view or template was specified for this element: ",a);var p=gb[n]||nc;c.addClass(n);for(var q=p.parentView;q&&q.Name;)c.addClass(q.Name),q=q.parentView;var r=jc[m]||pc,s={Name:n,origOuterHTML:e,el:a,templateId:j,domParentView:b,rootObj:r,rootStr:jc[m]?"":m};return delete jc[m],p.make(s)})}function Y(a,c,d,e){var f=[].slice.call(arguments),g=f.shift();"string"==typeof g?(a=g,g=f.shift()):a="v"+Bb++,g&&g.extend?(c=g,g=f.shift()):c=nc,"function"==typeof g?(d=g,g=f.shift()):d=null,e=_.extend({},g||{},{Name:a});var h=c.ready;return d&&(e.ready=h===b?d:function(){h.call(this),d.call(this)}),gb[a]=c.extend(e)}var Z,_;"undefined"!=typeof exports?(_=require("underscore")._,Z=exports):(Z=window,_=Z._);var ab,bb,cb=Z.TBONE_DEBUG!==!1,db={},eb={},fb={},gb={},hb=cb?{aliasCheck:!1}:{},ib=3e3,jb=2e3,kb=1e3,lb={highest:1e4,bound:ib,beforeViews:jb+500,view:jb,afterViews:jb-500,async:kb,lowest:0},mb=5e3,nb=Object.prototype.toString,ob=1,pb=2,qb=3,rb=4,sb={type:{},context:{},event:{},base:pb},tb=!1,ub=0,vb=[],wb=[];_.extend(y.prototype,{isScope:!0,trigger:function(){D(this)},execute:function(){var a,b=this;if(!b.destroyed){cb&&(a=v()),b.unbindAll(),b.destroySubScopes();var c=bb;this.lookups=bb={};var d=ab;if(ab=b,cb)b.fn.call(b.context);else try{b.fn.call(b.context)}catch(e){pc.push("__errors__."+b.Name,(e&&e.stack||e)+"")}if(_.each(bb,function(a){var c=a.obj,d=a.props;if(d[""])c.on("change",b.trigger,b);else for(var e in d)c.on("change:"+e,b.trigger,b)}),b.onExecuteCb&&b.onExecuteCb.call(b.onExecuteContext,this),bb=c,ab=d,cb){var f=a.done();o(rb,b,"exec","<%=priority%> <%=duration%>ms <%=name%>",{priority:b.priority,Name:b.Name,duration:f}),f>10&&o(rb,b,"slowexec","<%=priority%> <%=duration%>ms <%=name%>",{priority:b.priority,Name:b.Name,duration:f})}}},unbindAll:function(){var a=this,b=a.lookups||{};for(var c in b){var d=b[c],e=d.obj,f=d.props;for(var g in f)e.off("change:"+g,null,a)}},destroySubScopes:function(){for(var a=0;a<this.subScopes.length;a++)this.subScopes[a].destroy();this.subScopes=[]},destroy:function(){this.destroyed=!0,this.unbindAll(),this.destroySubScopes()}});var xb,yb,zb,Ab,Bb=1,Cb=[],Db={},Eb=0,Fb=!1,Gb=this.$&&$.fn&&$.fn.scrollTop,Hb=Gb&&$(window);Gb&&($.fn.scrollTop=function(a){return a&&(Ab=!0),Gb.apply(this,arguments)});var Ib=1,Jb=2,Kb=3,Lb=4,Mb=5,Nb=6,Ob=7,Pb=8,Qb=9,Rb="",Sb=16,Tb=/[.]+/,Ub={isModel:!0,make:function(a){var b=this,d=function(a,b,c){return"function"==typeof a?w(a,b):"function"!=typeof b||h(b)?0===arguments.length?d.query():1===arguments.length?d.query(a):2===arguments.length?d.query(a,b):d.query(a,b,c):d.query(a,Vb.extend({state:b}).make())};return _.extend(d,b,c(a)?{state:a}:a||{}),delete d.tboneid,delete d.attributes,cb&&delete d.prevJson,d._events={},d._removeCallbacks={},z(d),d.initialize(),d},extend:function(a){return _.extend({},this,a)},initialize:b,on:function(a,b,c){for(var d,e=N(a),f=this._events;null!=(d=e.shift());)""!==d&&(f[d]||(f[d]={}),f=f[d]);var g=f[""];g||(g=f[""]={});var h=z(c);g[h]=c,this.wake({})},off:function(a,b,c){for(var d,e=N(a),f=this._events;null!=(d=e.shift());)""!==d&&(f[d]||(f[d]={}),f=f[d]);var g=f[""];if(g){var h=z(c);delete g[h]}},trigger:function(a){for(var b,c=this,d=c._events,e=N(a);null!=(b=e.shift());)""!==b&&(d[b]||(d[b]={}),d=d[b]);var f=d[Rb]||{};for(var g in f)f[g].trigger.call(f[g])},runOnlyOnce:x,query:L,queryModel:function(a){return this.query(Ib,a)},readSilent:function(a){var b=bb;bb=null;var c=this.query(a);return bb=b,c},idAttribute:"id",queryId:function(){return this.query(this.idAttribute)},toggle:function(a){this.query(Ob,a)},push:function(a,b){1===arguments.length&&(b=a,a=""),this.query(Kb,a,b)},unshift:function(a,b){1===arguments.length&&(b=a,a=""),this.query(Lb,a,b)},removeFirst:function(a){this.query(Mb,a)},removeLast:function(a){this.query(Nb,a)},unset:function(a){this.query(Pb,a)},increment:function(a,b){this.query(Qb,a,null!=b?b:1)},clear:function(){this.query("",void 0)},toJSON:function(){return this.attributes},wake:b,queryText:M,text:M,lookup:L,lookupText:M,set:L,get:L};cb&&(Ub.find=function(a){function b(c,d){if(d>10)return[];if(c===a)return[];if(h(c)){if(e=b(c.attributes,d+1))return e}else if(null!==c&&"object"==typeof c){var e;if(c.push){for(var f=0;f<c.length;f++)if(e=b(c[f],d+1))return e.unshift(g),e}else for(var g in c)if(e=b(c[g],d+1))return e.unshift(g),e}}var c=b(this.attributes,0);return c?c.join("."):null});var Vb=Ub.extend({initialize:function(){var a=this;a.scope=w(a.update,a.scopePriority,a,a.Name&&"model_"+a.Name,a.onScopeExecute,a,!0)},scopePriority:ib,wake:function(a){this.sleeping&&(this.sleeping=!1,this.reset()),_.each(this.scope&&this.scope.lookups||[],function(b){var c=b.obj;c&&!a[z(c)]&&(a[z(c)]=!0,c.wake(a))})},onScopeExecute:function(a){o(qb,this,"lookups",a.lookups)},update:function(){var a=this;a.sleeping=a.sleepEnabled&&!t(a),a.sleeping?o(qb,a,"sleep"):a._update()},_update:function(){this.query(Rb,this.state()),o(rb,this,"updated",this.attributes)},reset:function(){this.scope&&this.scope.trigger()},destroy:function(){this.scope&&this.scope.destroy(),this.unset(Rb)},state:b,sleepEnabled:!1}),Wb=Vb.extend({_update:function(){var a=this,b=a.reqGeneration=(a.reqGeneration||0)+1,c=a.state(function(c){return b>=(a.updateGeneration||0)?(a.updateGeneration=b,a.abortCallback=null,a.query("",c),!0):void 0});a.abortCallback=c&&c.onAbort},abortPrevious:function(){this.abortCallback&&this.abortCallback()},scopePriority:kb}),Xb=1,Yb=Ub.extend({isCollection:!0,isModel:!0,model:Ub,add:function(a){var b,c,d=this;h(a)?b=a:(b=d.model.make(),b.query("",a));var e,f=function(){if(null!=c&&(d.unset(c,null),d.trigger("change:"+c),delete d._removeCallbacks[c]),!e){var a=b.queryId();null==a&&(a="__unidentified"+Xb++),a="#"+a,d.query(a,b),d.trigger("change:"+a),d._removeCallbacks[a]=g,c=a}};d.increment("size");var g=function(){d.increment("size",-1),e=!0,f()};w(f)},remove:function(a){a="#"+(h(a)?a.queryId():a),this._removeCallbacks[a]&&this._removeCallbacks[a]()}}),Zb={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"},$b=Wb.extend({state:function(a){function b(){c&&(Eb--,c=null,d.onComplete())}var c,d=this,e=d.url();return null!=e&&e!==d.fetchedUrl&&(d.fetchedUrl=e,d.abortPrevious(),d.clearOnFetch&&d.clear(),O("read",d,{dataType:"text",success:function(b){a(d.parse(b))&&(d.postFetch(),d.trigger("fetch"),o(qb,d,"updated",d.attributes))},complete:b,beforeSend:function(a){Eb++,c=a,a.__tbone__=!0},url:e})),{onAbort:function(){c&&(o(pb,d,"abort","aborting obsolete ajax request. old url: <%=oldurl%>",{oldurl:d.fetchedUrl}),c.abort(),b())}}},parse:a,ajax:function(){return $.ajax.apply($,arguments)},postFetch:b,onComplete:b,clearOnFetch:!0,sleepEnabled:!0}),_b=Ub.extend({initialize:function(){var a=this;a.query("",JSON.parse(localStorage[a.key]||"null")),w(function(){localStorage[a.key]=JSON.stringify(a.query(""))})}}),ac=Ub.extend({initialize:function(){function a(){b("hash",location.hash)}var b=this;$(window).bind("hashchange",function(){a()}),a(),b(function(){var a=b("hash");location.hash!==a&&(location.hash=a)})}}),bc=Yb.extend({initialize:function(){var a=this,b=JSON.parse(localStorage[a.key]||"null");_.each(b||[],function(b){a.add(b)}),w(function(){localStorage[a.key]=JSON.stringify(a.query())})}}),cc=/<%(=|-|@|)([\s\S]+?)%>/g,dc=P("function \\( ([\\w$_]* (, [\\w$_]+)*)  \\)|(\\{)|(\\})|([\\s\\S])","g"),ec=/[\w$_]+/g,fc=/([^'"]+)('[^']+'|"[^"]+")?/g,gc=P("(\\. )?(([\\w$_]+)(\\.[\\w$_]+)*)","g"),hc=/^\d+$/,ic={};_.each("break case catch continue debugger default delete do else finally for function if in instanceof new return switch this throw try typeof var void while with Array Boolean Date Function Iterator Number Object RegExp String isFinite isNaN parseFloat parseInt Infinity JSON Math NaN undefined true false null $ _ tbone T view window".split(" "),function(a){ic[a]=!0});var jc={},kc="0123456789ABCDEF",lc=0,mc={make:function(a){var b={};return _.extend(b,this),b.initialize(a),b},extend:function(a){return _.extend({},this,a,{parentView:this})},$:function(a){return this.$el.find(a)},isView:!0,initialize:function(a){var b=this;z(b),_.extend(b,a),b.$el=$(b.el),b.el.view=b,b.priority=b.domParentView?b.domParentView.priority-1:jb,b.scope=w(b.render,b.priority,b,"view_"+b.Name,b.onScopeExecute,b,!0)},onScopeExecute:function(a){o(qb,this,"lookups",a.lookups)},destroy:function(a){var b=this;o(rb,b,"destroy","due to re-render of "+a.Name),b.destroyed=!0,b.scope.destroy(),_.each(b.subViews||[],function(a){a.destroy(b)}),b.destroyDOM(b.$el)},render:function(){var a=this;if(!a.destroyed){if(n(a),lc++,a.templateId){var b,c,d,e,f=document.activeElement;if(_.contains($(f).parents(),a.el)){b="input",c=_.indexOf(a.$(b),f);var g=f.getAttribute("type");"submit"!==g&&"button"!==g&&(d=f.selectionStart,e=f.selectionEnd)}var h=$("<div>").append(this.$el.children()),i=U(a.templateId,a);o(qb,a,"newhtml",i),a.$el.html(i),a.ready(),a.postReady();var j=a.subViews||[];a.subViews=X(a.$("[tbone]"),a,j);var k=_.difference(j,a.subViews);if(_.each(k,function(b){b.destroy(a)}),a.destroyDOM(h),b){var l=a.$(b)[c];l&&($(l).focus(),null!=d&&null!=e&&(l.selectionStart=d,l.selectionEnd=e))}}else a.ready(),a.postReady();a.postRender(),ub++,lc--}},ready:b,postReady:b,postRender:b,destroyDOM:function(){},root:function(){return this.query(Ib)},query:function(a,b,c){var d=!1;return"number"!=typeof a&&(c=b,b=a,a=0,d=2===arguments.length),b=(this.rootStr?this.rootStr+".":"")+(b||""),d?this.rootObj(a,b,c):this.rootObj(a,b)},parentRoot:function(){return this.domParentView&&this.domParentView.root()},parent:function(){return this.domParentView},getHashId:V,isQueryable:h,denullText:r},nc=mc,oc=/[^\w.]*([\w.]+)[^\w.]+([\w.]+)/g,pc=Ub.make({Name:"tbone"}),qc=Z.tbone,rc=Z.T;Z.tbone=pc,Z.T=pc,pc.models=db,pc.views=gb,pc.collections=eb,pc.templates=fb,pc.createView=Y,pc.setDefaultView=W,pc.addTemplate=S,pc.dontPatch=Q,pc.render=X,pc.denullText=r,pc.priority=lb,pc.drain=G,pc.isReady=B,pc.noConflict=function(){Z.T=rc,Z.tbone=qc},db.base=Ub,db.bound=Vb,db.async=Wb,db.ajax=$b,db.localStorage=_b,db.location=ac,eb.base=Yb,eb.localStorage=bc,gb.base=mc,cb&&(pc.watchLog=l,pc.showRenderTrees=m,pc.getListeners=s,pc.hasViewListener=t,pc.onLog=q,pc.freeze=H,pc.opts=hb,q(p));try{dispatchEvent(new CustomEvent("tbone_loaded"))}catch(sc){}var tc=Z.Backbone;if(tc){var uc=function(a,b,c){var d=a===Ib,e=a===Jb,f=a===Ob,g=3===arguments.length,i=f||g;"number"!=typeof a&&(c=b,b=a,a=0,2===arguments.length&&(i=!0,g=!0)),b=(b||"").replace(/\.?(__self__)?\.?$/,"");var j,k=b.split(".");i&&(j=k[k.length-1]);for(var l,m,n,o,p=d&&!b?this:this.isCollection?this.models:this.attributes,q=[],r=k[0]||"",s=b?p[r]:p;null!=(n=k.shift());)if(n!==Rb)if(q.push(n),l=p,p=p[n],null==p){if(!i)break;p=hc.exec(k[0])?[]:{},l[n]=p}else if(h(p)){o=!0;break}if(!i&&bb&&(m=z(this),bb[m]||(bb[m]={obj:this,props:{}}),bb[m].props[r]=s),o&&(!d||k.length))return g?p.query(a,k.join("."),c):p.query(a,k.join("."));if(i){if(null==l)if(this.isCollection)this.reset(null!=c?c:[]);else if(c){for(var t in this.toJSON())void 0===c[t]&&this.unset(t);this.set(c)}else this.clear();else f?c=l[j]=!p:l[j]!==c&&(l[j]=c),r&&this.trigger("change:"+r),this.trigger("change");return c}return p&&!e&&this.isCollection&&b===Rb&&(p=_.map(p,function(a){return a.query()})),p},vc=tc.Model.extend({isModel:!0,initialize:function(){var a=this;z(a);var b=a.sleeping=a.isAsync(),c=b?kb:ib;D({execute:function(){a.scope=w(a.update,c,a,"model_"+a.Name,a.onScopeExecute,a)},priority:c+mb})},isAsync:function(){return!!this._url},onScopeExecute:function(a){o(qb,this,"lookups",a.lookups)},reset:function(){this.scope&&this.scope.trigger()},isVisible:function(){return t(this)},update:function(){var a=this;a.isAsync()?a.updateAsync():a.updateSync()},updateAsync:function(){function a(){b===c.xhrInFlight&&(Eb--,delete c.xhrInFlight)}var b,c=this,d=c.url(),e=c.fetchedUrl;c.sleeping=!this.isVisible(),c.sleeping?(o(qb,c,"sleep"),c.sleeping=!0):null!=d&&d!==e&&(c.fetchedUrl=d,c.clearOnFetch&&c.clear(),c.fetch({dataType:"text",success:function(){c.postFetch(),c.trigger("fetch"),o(qb,c,"updated",c.toJSON())},complete:a,beforeSend:function(f){c.xhrInFlight&&(o(pb,c,"abort","aborting obsolete ajax request. old: <%=oldurl%>, new: <%=newurl%>",{oldurl:e,newurl:d}),c.xhrInFlight.abort(),a()),Eb++,b=c.xhrInFlight=f,f.__tbone__=!0},url:d}))},updateSync:function(){var a=this;a.state&&(a.query(Rb,a.state()),o(qb,a,"updated",a.toJSON()))},state:null,postFetch:b,clearOnFetch:!0});_.each([tc.Model.prototype,tc.Collection.prototype],function(a){_.extend(a,{isBackbone:!0,query:uc,text:M,lookup:uc,lookupText:M,wake:function(a){this.sleeping&&(this.trigger("wake"),this.sleeping=!1,this.reset()),_.each(this.scope&&this.scope.lookups||[],function(b){var c=b.obj;c&&!a[z(c)]&&(a[z(c)]=!0,c.wake(a))})}});var b=a.on;a.on=function(){return this.wake({}),b.apply(this,arguments)}});var wc=db.bbbase=vc,xc=eb.bbbase=tc.Collection.extend({isCollection:!0});_.each([wc,xc],function(a){_.extend(a.prototype,{_validate:function(){return!0}})})}}();
//# sourceMappingURL=dist/tbone.js.map