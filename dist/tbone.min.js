(function(){function n(){}function H(a){return null!==a&&"object"===typeof a&&!E(a)}function E(a){return!!(a&&a.getTimezoneOffset&&a.setUTCFullYear)}function z(a){return!(!a||"function"!==typeof a.query)}function R(a){return"string"===typeof a||"number"===typeof a&&!isNaN(a)||E(a)||"boolean"===typeof a?a+"":""}function pa(a){var b=[];e.each(e.values(a._callbacks||{}),function(a){for(a=a.next;;)if(a.context)b.push(a.context),a=a.next;else break});e.each(e.flatten(e.values(a._events||{})),function(a){a.context&&
b.push(a.context)});if(z(a)&&"function"===typeof a){a=[a._events];for(var c,d,h;c=a.pop();)for(h in c)if(""===h){d=c[""];for(var f in d)b.push(d[f])}else a.push(c[h])}return e.uniq(b)}function ea(a){var b=[a];for(a=[a];b.length;)for(var c=b.pop(),c=pa(c),d=0;d<c.length;d++){var h=c[d];h.G&&(h=h.context);if(h){if(h.H)return!0;h.n&&-1===a.indexOf(h)&&(b.push(h),a.push(h))}}return!1}function S(a){return a.replace(/^change:/,"change.").split(qa)}function t(a,b,c,d,h,f,e){b||(b=A?A.b-1:4E3);!d&&A&&(d=
A.N+"+");a=new fa(a,c,b,d,h,f);!e&&A&&A.h.push(a);a.execute();return a}function fa(a,b,c,d,h,f){e.extend(this,{fn:a,context:b,b:c,Name:d,u:h,I:f,h:[]})}function y(a){return a.tboneid=a.tboneid||ga++}function ra(){T&&(L.sort(function(a,b){return a.b-b.b}),T=!1);return L.pop()}function ha(){U||(U=setTimeout(function(){k.query("__isReady__",sa());k.query("__ajaxReady__",!v);k.query("__numAjaxInFlight__",v);U=null},20))}function ia(a){var b=y(a);V[b]||(V[b]=!0,L.push(a),T=!0,C||(ha(),C=e.defer(W)))}function X(a){return M&&
(a?ja.scrollTop(a):ja.scrollTop())}function W(){Y=!1;var a=X(),b;C=null;C=L.length?e.defer(W):null;for(var c=5E3;--c&&(b=ra());)delete V[y(b)],b.execute();ha();a&&!Y&&a!==X()&&X(a)}function I(a,b,c,d,h,f,e){if(16<f)return!0;b=b||{};if(z(d)||z(c))e=!0;var g=e,l;for(l in b)""===l?d!==c&&(H(d)&&H(c)?h=!0:g=E(d)&&E(c)?d.getTime()!==c.getTime()||g:!0):g=I(a,b[l],c&&c[l],d&&d[l],!1,f+1,e)||g;if(h&&!g)if(H(d)&&H(c)){e={};var k=[d,c];for(h=0;2>h&&!g;h++){var F=k[h];if("[object Array]"===ka.call(F))for(d.length!==
c.length&&(g=!0),l=0;l<F.length&&!g;l++)e[l]||(e[l]=!0,I(a,b[l],c[l],d[l],!0,f+1,!1)&&(g=!0));else for(l in F)if(!e[l]&&(e[l]=!0,I(a,b[l],c[l],d[l],!0,f+1,!1))){g=!0;break}}}else E(d)&&E(c)?g=d.getTime()!==c.getTime():d!==c&&(g=!0);if(g){a=b[""]||{};for(var q in a)a[q].trigger.call(a[q])}return g}function N(a,b,c){var d=1===a,h=2===a,f=3===a,da=4===a,g=5===a,l=6===a,k=7===a,F=9===a,q=f||da||g||l,O=8===a,s=10===a,r=3===arguments.length,D=q||k||O||r||F;"number"!==typeof a&&(c=b,b=a,a=0,2===arguments.length&&
(r=D=!0));b=(b||"").replace("__self__","");var m=b.split("."),x=[],B;for(B=0;B<m.length;B++)m[B]&&x.push(m[B]);m=x[x.length-1]||"attributes";B=this;for(var p=d&&!b?this:this.attributes,n=[],u,A,t={},v=D&&this._events.change;;){if(null==p&&!D){n=n.concat(x);break}else if(p!==this&&z(p)){A=x.length||(D?!O&&!z(c):!d);break}else if(D&&!H(p)&&(x.length||q)){if(O)return;p=(x.length?Z.exec(x[0]):q)?[]:{};this.query(n.join("."),p)}u=x.shift();if(null==u)break;n.push(u);B=p;p=p[u];v&&(e.extend(t,v[""]||{}),
v=v[u])}!D&&w&&(d=y(this),w[d]||(w[d]={obj:this,props:{}}),w[d].props[n.join(".")]=p);if(A)return r?p.query(a,x.join("."),c):p.query(a,x.join("."));if(D){f?p.push(c):da?p.unshift(c):g?p.shift(c):l?p.pop(c):O?delete B[m]:k?c=B[m]=!p:F?c=B[m]=(p||0)+c:B[m]=c;if(e.isEmpty(t))I(this,v,p,c,!1,0,s);else if(I(this,v,p,c,!0,0,s))for(var C in t)t[C].trigger.call(t[C]);return c}!h&&this.e&&""===b&&("[object Array]"===ka.call(p)?p=e.map(p,function(a){return a.query()}):p&&(p=e.reduce(e.keys(p),function(a,b){z(p[b])&&
(a[b]=p[b].query());return a},{})));return p}function J(a,b){return R(null==b?this.query(a):this.query(a,b))}function ta(a,b){var c=ua.read;e.defaults(b||(b={}),{emulateHTTP:k.emulateHTTP,emulateJSON:k.emulateJSON});var d={type:c,dataType:"json"};b.url||(d.url=e.result(a,"url")||urlError());b.emulateJSON&&(d.contentType="application/x-www-form-urlencoded",d.data=d.data?{model:d.data}:{});if(b.emulateHTTP&&("PUT"===c||"DELETE"===c||"PATCH"===c)){d.type="POST";b.emulateJSON&&(d.data.O=c);var h=b.F;
b.F=function(a){a.setRequestHeader("X-HTTP-Method-Override",c);if(h)return h.apply(this,arguments)}}"GET"===d.type||b.emulateJSON||(d.processData=!1);"PATCH"!==d.type||!window.ActiveXObject||window.external&&window.external.P||(d.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});b.xhr=a.ajax(e.extend(d,b))}function va(a,b){return a.replace(wa,function(a,d,h,f){return aa[f]||d||Z.test(f)?a:null!=b[f]?["(",f," && view.isQueryable(",f,") ? ",f,'.query("',h.slice(f.length+1),'") : ',h,")"].join(""):
['view.query(2, "',h,'")'].join("")})}function xa(a){function b(){d=e.invert(e.flatten(c))}var c=[[]],d={};b();a=a.replace(ya,function(a,f,e){function g(){var a=va(l.join(""),d);l=[];return a}var l=[];(a="@"===f)&&(f="");e=e.replace(za,function(a,d,h){return d.replace(Aa,function(a,d,h,f,e,k){if(k)return l.push(k),"";f?c.push([]):d?d.replace(Ba,function(a){c[c.length-1].push(a)}):e&&c.pop();b();return g()+a})+g()+(h||"")})+g();return"<%"+(a?"= view.getHashId("+e+") ":f?f+"view.denullText("+e+")":
e)+"%>"});return e.template(a,null,{variable:"view"})}function Ca(a,b){var c=K[a];if(null==c&&(c=s('script[name="'+a+'"]').html(),!c))return"";"string"===typeof c&&(c=K[a]=xa(c));return c(b)}function la(a,b,c){var d={};e.each(c||[],function(a){(d[a.v]=d[a.v]||[]).push(a)});return e.map(a,function(a){var c=s(a),e=a.outerHTML,g=a.__tboneview__;if(!g){if(d[e]&&d[e].length)e=d[e].shift(),c.replaceWith(e.el),g=e;else{var l={};(c.attr("tbone")||"").replace(Da,function(a,b,c){l[b]=c});if(g=l.inline){var m=
c.html().replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&");K[g]=m}var r=g||l.tmpl,g=l.root,q=l.view||r,m=P[q]||ba;c.addClass(q);for(var n=m.w;n&&n.Name;)c.addClass(n.Name),n=n.w;c={Name:q,v:e,el:a,q:r,d:b,A:Q[g]||k,B:Q[g]?"":g};delete Q[g];g=m.make(c)}a.__tboneview__=g}return g})}var m,e,s;"undefined"!==typeof exports?(e=require("underscore")._,m=exports):(m=window,e=m._,s=m.$);var u={},G={},K={},P={},ka=Object.prototype.toString,Z=/^\d+$/,Ea=0,qa=/[.]+/,r={n:!0,make:function(a){function b(a,
d,e){return"function"===typeof a?t(a,d):"function"!==typeof d||z(d)?0===arguments.length?b.query():1===arguments.length?b.query(a):2===arguments.length?b.query(a,d):b.query(a,d,e):b.query(a,ma.extend({state:d}).make())}e.extend(b,this,"function"===typeof a?{state:a}:a||{});delete b.tboneid;delete b.attributes;b._events={};b.g={};y(b);b.initialize();return b},extend:function(a){return e.extend({},this,a)},initialize:n,on:function(a,b,c){b=S(a);a=this._events;for(var d;null!=(d=b.shift());)""!==d&&
(a[d]||(a[d]={}),a=a[d]);(b=a[""])||(b=a[""]={});a=y(c);b[a]=c;this.c({})},off:function(a,b,c){a=S(a);b=this._events;for(var d;null!=(d=a.shift());)""!==d&&(b[d]||(b[d]={}),b=b[d]);if(a=b[""])c=y(c),delete a[c]},trigger:function(a){var b=this._events;a=S(a);for(var c;null!=(c=a.shift());)""!==c&&(b[c]||(b[c]={}),b=b[c]);var b=b[""]||{},d;for(d in b)b[d].trigger.call(b[d])},runOnlyOnce:function(a){var b;t(function(){b||a()});b=!0},query:N,queryModel:function(a){return this.query(1,a)},readSilent:function(a){var b=
w;w=null;a=this.query(a);w=b;return a},idAttribute:"id",queryId:function(){return this.query(this.idAttribute)},toggle:function(a){this.query(7,a)},push:function(a,b){1===arguments.length&&(b=a,a="");this.query(3,a,b)},unshift:function(a,b){1===arguments.length&&(b=a,a="");this.query(4,a,b)},removeFirst:function(a){this.query(5,a)},removeLast:function(a){this.query(6,a)},unset:function(a){this.query(8,a)},increment:function(a,b){this.query(9,a,null!=b?b:1)},clear:function(){this.query("",void 0)},
toJSON:function(){return this.attributes},c:n,queryText:J,text:J,lookup:N,lookupText:J,set:N,get:N},k=r.make({Name:"tbone"}),Fa=m.tbone,Ga=m.T;m.tbone=k;m.T=k;k.noConflict=function(){m.T=Ga;m.tbone=Fa};k.models=u;u.base=r;var A,w;e.extend(fa.prototype,{G:!0,trigger:function(){ia(this)},execute:function(){var a=this;if(!a.k){a.D();a.s();var b=w;this.o=w={};var c=A;A=a;try{a.fn.call(a.context)}finally{e.each(w,function(b){var c=b.obj;b=b.props;if(b[""])c.on("change",a.trigger,a);else for(var e in b)c.on("change:"+
e,a.trigger,a)}),a.u&&a.u.call(a.I,this),w=b,A=c}}},D:function(){var a=this.o||{},b;for(b in a){var c=a[b],d=c.obj,c=c.props,e;for(e in c)d.off("change:"+e,null,this)}},s:function(){for(var a=0;a<this.h.length;a++)this.h[a].destroy();this.h=[]},destroy:function(){this.k=!0;this.D();this.s()}});var ga=1,L=[],T,V={},C,v=0,sa=k.isReady=function(){return!v&&!C},U,M=this.$&&s.fn&&s.fn.scrollTop,ja=M&&s(window),Y;M&&(s.fn.scrollTop=function(a){a&&(Y=!0);return M.apply(this,arguments)});k.drain=function(){C&&
clearTimeout(C);W()};var ma=u.bound=r.extend({initialize:function(){this.scope=t(this.update,this.C,this,this.Name&&"model_"+this.Name,this.f,this,!0)},C:3E3,c:function(a){this.a&&(this.a=!1,this.reset());e.each(this.scope&&this.scope.o||[],function(b){(b=b.obj)&&!a[y(b)]&&(a[y(b)]=!0,b.c(a))})},f:function(){},update:function(){(this.a=this.sleepEnabled&&!ea(this))||this.r()},r:function(){this.query(this.assumeChanged?10:0,"",this.state())},reset:function(){this.scope&&this.scope.trigger()},destroy:function(){this.scope&&
this.scope.destroy();this.unset("")},state:n,sleepEnabled:!1}),ca=u.async=ma.extend({r:function(){var a=this,b=a.J=(a.J||0)+1,c=a.state(function(c){if(b>=(a.L||0))return a.L=b,a.j=null,a.query("",c),!0});a.j=c&&c.onAbort},abortPrevious:function(){this.j&&this.j()},C:1E3}),Ha=1,Ia=G.base=r.extend({e:!0,n:!0,model:r,add:function(a){function b(){d.increment("size",-1);k=!0;c()}function c(){null!=f&&(d.unset(f,null),d.trigger("change:"+f),delete d.g[f]);if(!k){var a=e.queryId();null==a&&(a="__unidentified"+
Ha++);a="#"+a;d.query(a,e);d.trigger("change:"+a);d.g[a]=b;f=a}}var d=this,e,f;z(a)?e=a:(e=d.model.make(),e.query("",a));var k;d.increment("size");t(c)},remove:function(a){a="#"+(z(a)?a.queryId():a);if(this.g[a])this.g[a]()}});k.collections=G;var ua={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};u.ajax=ca.extend({state:function(a){function b(){d&&(v--,d=null,c.onComplete())}var c=this,d,e=c.url();null!=e&&e!==c.l&&(c.l=e,c.abortPrevious(),c.clearOnFetch&&c.clear(),ta(c,{dataType:"text",
success:function(b){a(c.parse(b))&&(c.postFetch(),c.trigger("fetch"))},complete:b,beforeSend:function(a){v++;d=a;a.__tbone__=!0},url:e}));return{Q:function(){d&&(d.abort(),b())}}},parse:function(a){return a},ajax:function(){return s.ajax.apply(s,arguments)},postFetch:n,onComplete:n,clearOnFetch:!0,sleepEnabled:!0});u.localStorage=r.extend({initialize:function(){var a=this;a.query("",JSON.parse(localStorage[a.key]||"null"));t(function(){localStorage[a.key]=JSON.stringify(a.R(""))})}});u.location=r.extend({initialize:function(){var a=
this;s(window).bind("hashchange",function(){a("hash",location.hash)});a("hash",location.hash);a(function(){var b=a("hash");location.hash!==b&&(location.hash=b)})}});G.localStorage=Ia.extend({initialize:function(){var a=this,b=JSON.parse(localStorage[a.key]||"null");e.each(b||[],function(b){a.add(b)});t(function(){localStorage[a.key]=JSON.stringify(a.query())})}});var ya=/<%(=|-|@|)([\s\S]+?)%>/g,Aa=RegExp("function \\( ([\\w$_]* (, [\\w$_]+)*)  \\)|(\\{)|(\\})|([\\s\\S])".replace(/ /g,"[\\s\\n]*"),
"g"),Ba=/[\w$_]+/g,za=/([^'"]+)('[^']+'|"[^"]+")?/g,wa=RegExp("(\\. )?(([\\w$_]+)(\\.[\\w$_]+)*)".replace(/ /g,"[\\s\\n]*"),"g"),aa={};e.each("break case catch continue debugger default delete do else finally for function if in instanceof new return switch this throw try typeof var void while with Array Boolean Date Function Iterator Number Object RegExp String isFinite isNaN parseFloat parseInt Infinity JSON Math NaN undefined true false null $ _ tbone T view window".split(" "),function(a){aa[a]=
!0});var Q={},na=0,ba=r={make:function(a){var b={};e.extend(b,this);b.initialize(a);return b},extend:function(a){return e.extend({},this,a,{w:this})},$:function(a){return this.$el.find(a)},H:!0,initialize:function(a){y(this);e.extend(this,a);this.$el=s(this.el);this.el.view=this;this.b=this.d?this.d.b-1:2E3;this.scope=t(this.render,this.b,this,"view_"+this.Name,this.f,this,!0)},f:function(){},destroy:function(){var a=this;a.k=!0;a.scope.destroy();e.each(a.p||[],function(b){b.destroy(a)});a.destroyDOM(a.$el)},
render:function(){var a=this,b,c,d,h,f;if(!a.k){na++;if(a.q){b=document.activeElement;if(e.contains(s(b).parents(),a.el)){c="input";d=e.indexOf(a.$(c),b);try{h=b.selectionStart,f=b.selectionEnd}catch(k){}}b=s("<div>").append(this.$el.children());var g=Ca(a.q,a);a.$el.html(g)}a.ready();a.postReady();g=a.p||[];a.p=la(a.$("[tbone]"),a,g);g=e.difference(g,a.p);e.each(g,function(b){b.destroy(a)});if(a.q&&(a.destroyDOM(b),c&&(c=a.$(c)[d]))&&(s(c).focus(),null!=h&&null!=f))try{c.selectionStart=h,c.selectionEnd=
f}catch(l){}a.postRender();Ea++;na--}},ready:n,postReady:n,postRender:n,destroyDOM:function(){},root:function(){return this.query(1)},query:function(a,b,c){var d=!1;"number"!==typeof a&&(c=b,b=a,a=0,d=2===arguments.length);b=(this.B?this.B+".":"")+(b||"");return d?this.A(a,b,c):this.A(a,b)},parentRoot:function(){return this.d&&this.d.root()},parent:function(){return this.d},getHashId:function(a){if(!z(a)){var b=k.make();b.query("",a);a=b}if(!a.m){for(var b=[],c=20;c;c--)b.push("0123456789ABCDEF".charAt(Math.floor(16*
Math.random())));a.m=b.join("")}Q[a.m]=a;return a.m},isQueryable:z,denullText:R},Da=/[^\w.]*([\w.]+)[^\w.]+([\w.]+)/g;k.views=P;k.templates=K;k.createView=function(a,b,c,d){var h=[].slice.call(arguments),f=h.shift();"string"===typeof f?(a=f,f=h.shift()):a="v"+ga++;f&&f.extend?(b=f,f=h.shift()):b=ba;"function"===typeof f?(c=f,f=h.shift()):c=null;d=e.extend({},f||{},{Name:a});var k=b.ready;c&&(d.ready=k===n?c:function(){k.call(this);c.call(this)});return P[a]=b.extend(d)};k.setDefaultView=function(a){ba=
a};k.addTemplate=function(a,b){K[a]=b};k.dontPatch=function(a){aa[a]=!0};k.render=la;k.denullText=R;k.priority={highest:1E4,bound:3E3,beforeViews:2500,view:2E3,afterViews:1500,async:1E3,lowest:0};P.base=r;try{m.dispatchEvent(new m.CustomEvent("tbone_loaded"))}catch(Ja){}if(r=m.Backbone){var oa=function(a,b,c){var d=1===a,h=2===a,f=7===a,k=3===arguments.length,g=f||k;"number"!==typeof a&&(c=b,b=a,a=0,2===arguments.length&&(k=g=!0));b=(b||"").replace(/\.?(__self__)?\.?$/,"");var l=b.split("."),m;g&&
(m=l[l.length-1]);for(var n,q=d&&!b?this:this.e?this.models:this.attributes,r=[],s=l[0]||"",u=b?q[s]:q,t,v;null!=(t=l.shift());)if(""!==t)if(r.push(t),n=q,q=q[t],null==q)if(g)q=Z.exec(l[0])?[]:{},n[t]=q;else break;else if(z(q)){v=!0;break}!g&&w&&(r=y(this),w[r]||(w[r]={obj:this,props:{}}),w[r].props[s]=u);if(v&&(!d||l.length))return k?q.query(a,l.join("."),c):q.query(a,l.join("."));if(g){if(null==n)if(this.e)this.reset(null!=c?c:[]);else if(c){for(var x in this.toJSON())void 0===c[x]&&this.unset(x);
this.set(c)}else this.clear();else f?c=n[m]=!q:n[m]!==c&&(n[m]=c),s&&this.trigger("change:"+s),this.trigger("change");return c}q&&!h&&this.e&&""===b&&(q=e.map(q,function(a){return a.query()}));return q},ca=r.Model.extend({n:!0,initialize:function(){var a=this;y(a);var b=(a.a=a.t())?1E3:3E3;ia({execute:function(){a.scope=t(a.update,b,a,"model_"+a.Name,a.f,a)},b:b+5E3})},t:function(){return!!this._url},f:function(){},reset:function(){this.scope&&this.scope.trigger()},isVisible:function(){return ea(this)},
update:function(){this.t()?this.K():this.M()},K:function(){function a(){c===b.i&&(v--,delete b.i)}var b=this,c,d=b.url(),e=b.l;b.a=!this.isVisible();b.a?b.a=!0:null!=d&&d!==e&&(b.l=d,b.clearOnFetch&&b.clear(),b.fetch({dataType:"text",success:function(){b.postFetch();b.trigger("fetch");b.toJSON()},complete:a,beforeSend:function(d){b.i&&(b.i.abort(),a());v++;c=b.i=d;d.__tbone__=!0},url:d}))},M:function(){this.state&&(this.query("",this.state()),this.toJSON())},state:null,postFetch:n,clearOnFetch:!0});
e.each([r.Model.prototype,r.Collection.prototype],function(a){e.extend(a,{isBackbone:!0,query:oa,text:J,lookup:oa,lookupText:J,c:function(a){this.a&&(this.trigger("wake"),this.a=!1,this.reset());e.each(this.scope&&this.scope.o||[],function(b){(b=b.obj)&&!a[y(b)]&&(a[y(b)]=!0,b.c(a))})}});var b=a.on;a.on=function(){this.c({});return b.apply(this,arguments)}});u=u.bbbase=ca;G=G.bbbase=r.Collection.extend({e:!0});e.each([u,G],function(a){e.extend(a.prototype,{_validate:function(){return!0}})})}})();
