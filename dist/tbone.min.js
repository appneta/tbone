(function(){function z(){}function H(a){return null!==a&&"object"===typeof a&&!E(a)}function E(a){return!!(a&&a.getTimezoneOffset&&a.setUTCFullYear)}function A(a){return!(!a||"function"!==typeof a.query)}function R(a){return"string"===typeof a||"number"===typeof a&&!isNaN(a)||E(a)||"boolean"===typeof a?a+"":""}function pa(a){var b=[];e.each(e.values(a._callbacks||{}),function(a){for(a=a.next;;)if(a.context)b.push(a.context),a=a.next;else break});e.each(e.flatten(e.values(a._events||{})),function(a){a.context&&
b.push(a.context)});if(A(a)&&"function"===typeof a){a=[a._events];for(var c,d,g;c=a.pop();)for(g in c)if(""===g){d=c[""];for(var f in d)b.push(d[f])}else a.push(c[g])}return e.uniq(b)}function ea(a){var b=[a];for(a=[a];b.length;)for(var c=b.pop(),c=pa(c),d=0;d<c.length;d++){for(var g=c[d];g&&!g.u&&!g.h;)g=g.A||g.context;if(g){if(g.u)return!0;g.h&&-1===a.indexOf(g)&&(b.push(g),a.push(g))}}return!1}function S(a){return a.replace(/^change:/,"change.").split(qa)}function t(a,b,c,d,g,f,e){b||(b=n?n.b-
1:4E3);!d&&n&&(d=n.N+"+");a=new fa(a,c,b,d,g,f);!e&&n&&(n.i.push(a),a.A=n);a.execute();return a}function fa(a,b,c,d,g,f){e.extend(this,{fn:a,context:b,b:c,Name:d,v:g,I:f,i:[]})}function y(a){return a.tboneid=a.tboneid||ga++}function ra(){T&&(L.sort(function(a,b){return a.b-b.b}),T=!1);return L.pop()}function ha(){U||(U=setTimeout(function(){k.query("__isReady__",sa());k.query("__ajaxReady__",!v);k.query("__numAjaxInFlight__",v);U=null},20))}function ia(a){var b=y(a);V[b]||(V[b]=!0,L.push(a),T=!0,
C||(ha(),C=e.defer(W)))}function X(a){return M&&(a?ja.scrollTop(a):ja.scrollTop())}function W(){Y=!1;var a=X(),b;C=null;C=L.length?e.defer(W):null;for(var c=5E3;--c&&(b=ra());)delete V[y(b)],b.execute();ha();a&&!Y&&a!==X()&&X(a)}function I(a,b,c,d,g,f,e){if(16<f)return!0;b=b||{};if(A(d)||A(c))e=!0;var h=e,l;for(l in b)""===l?d!==c&&(H(d)&&H(c)?g=!0:h=E(d)&&E(c)?d.getTime()!==c.getTime()||h:!0):h=I(a,b[l],c&&c[l],d&&d[l],!1,f+1,e)||h;if(g&&!h)if(H(d)&&H(c)){e={};var k=[d,c];for(g=0;2>g&&!h;g++){var F=
k[g];if("[object Array]"===ka.call(F))for(d.length!==c.length&&(h=!0),l=0;l<F.length&&!h;l++)e[l]||(e[l]=!0,I(a,b[l],c[l],d[l],!0,f+1,!1)&&(h=!0));else for(l in F)if(!e[l]&&(e[l]=!0,I(a,b[l],c[l],d[l],!0,f+1,!1))){h=!0;break}}}else E(d)&&E(c)?h=d.getTime()!==c.getTime():d!==c&&(h=!0);if(h){a=b[""]||{};for(var q in a)a[q].trigger.call(a[q])}return h}function N(a,b,c){var d=1===a,g=2===a,f=3===a,da=4===a,h=5===a,l=6===a,k=7===a,F=9===a,q=f||da||h||l,O=8===a,s=10===a,r=3===arguments.length,D=q||k||O||
r||F;"number"!==typeof a&&(c=b,b=a,a=0,2===arguments.length&&(r=D=!0));b=(b||"").replace("__self__","");var m=b.split("."),x=[],B;for(B=0;B<m.length;B++)m[B]&&x.push(m[B]);m=x[x.length-1]||"attributes";B=this;for(var p=d&&!b?this:this.attributes,n=[],u,z,t={},v=D&&this._events.change;;){if(null==p&&!D){n=n.concat(x);break}else if(p!==this&&A(p)){z=x.length||(D?!O&&!A(c):!d);break}else if(D&&!H(p)&&(x.length||q)){if(O)return;p=(x.length?Z.exec(x[0]):q)?[]:{};this.query(n.join("."),p)}u=x.shift();if(null==
u)break;n.push(u);B=p;p=p[u];v&&(e.extend(t,v[""]||{}),v=v[u])}!D&&w&&(d=y(this),w[d]||(w[d]={obj:this,props:{}}),w[d].props[n.join(".")]=p);if(z)return r?p.query(a,x.join("."),c):p.query(a,x.join("."));if(D){f?p.push(c):da?p.unshift(c):h?p.shift(c):l?p.pop(c):O?delete B[m]:k?c=B[m]=!p:F?c=B[m]=(p||0)+c:B[m]=c;if(e.isEmpty(t))I(this,v,p,c,!1,0,s);else if(I(this,v,p,c,!0,0,s))for(var C in t)t[C].trigger.call(t[C]);return c}!g&&this.e&&""===b&&("[object Array]"===ka.call(p)?p=e.map(p,function(a){return a.query()}):
p&&(p=e.reduce(e.keys(p),function(a,b){A(p[b])&&(a[b]=p[b].query());return a},{})));return p}function J(a,b){return R(null==b?this.query(a):this.query(a,b))}function ta(a,b){var c=ua.read;e.defaults(b||(b={}),{emulateHTTP:k.emulateHTTP,emulateJSON:k.emulateJSON});var d={type:c,dataType:"json"};b.url||(d.url=e.result(a,"url")||urlError());b.emulateJSON&&(d.contentType="application/x-www-form-urlencoded",d.data=d.data?{model:d.data}:{});if(b.emulateHTTP&&("PUT"===c||"DELETE"===c||"PATCH"===c)){d.type=
"POST";b.emulateJSON&&(d.data.O=c);var g=b.H;b.H=function(a){a.setRequestHeader("X-HTTP-Method-Override",c);if(g)return g.apply(this,arguments)}}"GET"===d.type||b.emulateJSON||(d.processData=!1);"PATCH"!==d.type||!window.ActiveXObject||window.external&&window.external.Q||(d.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});b.xhr=a.ajax(e.extend(d,b))}function va(a,b){return a.replace(wa,function(a,d,g,f){return aa[f]||d||Z.test(f)?a:null!=b[f]?["(",f," && view.isQueryable(",f,") ? ",
f,'.query("',g.slice(f.length+1),'") : ',g,")"].join(""):['view.query(2, "',g,'")'].join("")})}function xa(a){function b(){d=e.invert(e.flatten(c))}var c=[[]],d={};b();a=a.replace(ya,function(a,f,e){function h(){var a=va(l.join(""),d);l=[];return a}var l=[];(a="@"===f)&&(f="");e=e.replace(za,function(a,d,g){return d.replace(Aa,function(a,d,g,f,e,k){if(k)return l.push(k),"";f?c.push([]):d?d.replace(Ba,function(a){c[c.length-1].push(a)}):e&&c.pop();b();return h()+a})+h()+(g||"")})+h();return"<%"+(a?
"= view.getHashId("+e+") ":f?f+"view.denullText("+e+")":e)+"%>"});return e.template(a,null,{variable:"view"})}function Ca(a,b){var c=K[a];null==c&&(c=s('script[name="'+a+'"]').html()||"");"string"===typeof c&&(c=K[a]=xa(c));return c(b)}function la(a,b,c){var d={};e.each(c||[],function(a){(d[a.w]=d[a.w]||[]).push(a)});return e.map(a,function(a){var c=s(a),e=a.outerHTML,h=a.__tboneview__;if(!h){if(d[e]&&d[e].length)e=d[e].shift(),c.replaceWith(e.el),h=e;else{var l={};(c.attr("tbone")||"").replace(Da,
function(a,b,c){l[b]=c});if(h=l.inline){var m=c.html().replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&");K[h]=m}var r=h||l.tmpl,h=l.root,q=l.view||r,m=P[q]||ba;c.addClass(q);for(var n=m.B;n&&n.Name;)c.addClass(n.Name),n=n.B;c={Name:q,w:e,el:a,q:r,d:b,C:Q[h]||k,D:Q[h]?"":h};delete Q[h];h=m.make(c)}a.__tboneview__=h}return h})}var m,e,s;"undefined"!==typeof exports?(e=require("underscore")._,m=exports):(m=window,e=m._,s=m.$);var u={},G={},K={},P={},ka=Object.prototype.toString,Z=/^\d+$/,
Ea=0,qa=/[.]+/,r={h:!0,make:function(a){function b(a,d,e){return"function"===typeof a?t(a,d):"function"!==typeof d||A(d)?0===arguments.length?b.query():1===arguments.length?b.query(a):2===arguments.length?b.query(a,d):b.query(a,d,e):b.query(a,ma.extend({state:d}).make())}e.extend(b,this,"function"===typeof a?{state:a}:a||{});delete b.tboneid;delete b.attributes;b._events={};b.g={};y(b);b.initialize();return b},extend:function(a){return e.extend({},this,a)},initialize:z,on:function(a,b,c){b=S(a);a=
this._events;for(var d;null!=(d=b.shift());)""!==d&&(a[d]||(a[d]={}),a=a[d]);(b=a[""])||(b=a[""]={});a=y(c);b[a]=c;this.c({})},off:function(a,b,c){a=S(a);b=this._events;for(var d;null!=(d=a.shift());)""!==d&&(b[d]||(b[d]={}),b=b[d]);if(a=b[""])c=y(c),delete a[c]},trigger:function(a){var b=this._events;a=S(a);for(var c;null!=(c=a.shift());)""!==c&&(b[c]||(b[c]={}),b=b[c]);var b=b[""]||{},d;for(d in b)b[d].trigger.call(b[d])},runOnlyOnce:function(a){var b;t(function(){b||a()});b=!0},query:N,queryModel:function(a){return this.query(1,
a)},readSilent:function(a){var b=w;w=null;a=this.query(a);w=b;return a},idAttribute:"id",queryId:function(){return this.query(this.idAttribute)},toggle:function(a){this.query(7,a)},push:function(a,b){1===arguments.length&&(b=a,a="");this.query(3,a,b)},unshift:function(a,b){1===arguments.length&&(b=a,a="");this.query(4,a,b)},removeFirst:function(a){this.query(5,a)},removeLast:function(a){this.query(6,a)},unset:function(a){this.query(8,a)},increment:function(a,b){this.query(9,a,null!=b?b:1)},clear:function(){this.query("",
void 0)},toJSON:function(){return this.attributes},c:z,queryText:J,text:J,lookup:N,lookupText:J,set:N,get:N},k=r.make({Name:"tbone"}),Fa=m.tbone,Ga=m.T;m.tbone=k;m.T=k;k.noConflict=function(){m.T=Ga;m.tbone=Fa};k.models=u;u.base=r;var n,w;e.extend(fa.prototype,{P:!0,trigger:function(){ia(this)},execute:function(){var a=this;if(!a.l){a.G();a.s();var b=w;this.o=w={};var c=n;n=a;try{a.fn.call(a.context)}finally{e.each(w,function(b){var c=b.obj;b=b.props;if(b[""])c.on("change",a.trigger,a);else for(var e in b)c.on("change:"+
e,a.trigger,a)}),a.v&&a.v.call(a.I,this),w=b,n=c}}},G:function(){var a=this.o||{},b;for(b in a){var c=a[b],d=c.obj,c=c.props,e;for(e in c)d.off("change:"+e,null,this)}},s:function(){for(var a=0;a<this.i.length;a++)this.i[a].destroy();this.i=[]},destroy:function(){this.l=!0;delete this.A;this.G();this.s()}});var ga=1,L=[],T,V={},C,v=0,sa=k.isReady=function(){return!v&&!C},U,M=this.$&&s.fn&&s.fn.scrollTop,ja=M&&s(window),Y;M&&(s.fn.scrollTop=function(a){a&&(Y=!0);return M.apply(this,arguments)});k.drain=
function(){C&&clearTimeout(C);W()};var ma=u.bound=r.extend({initialize:function(){this.scope=t(this.update,this.F,this,this.Name&&"model_"+this.Name,this.f,this,!0)},F:3E3,c:function(a){this.a&&(this.a=!1,this.reset());e.each(this.scope&&this.scope.o||[],function(b){(b=b.obj)&&!a[y(b)]&&(a[y(b)]=!0,b.c(a))})},f:function(){},update:function(){(this.a=this.sleepEnabled&&!ea(this))||this.r()},r:function(){this.query(this.assumeChanged?10:0,"",this.state())},reset:function(){this.scope&&this.scope.trigger()},
destroy:function(){this.scope&&this.scope.destroy();this.unset("")},disableSleep:function(){},state:z,sleepEnabled:!1}),ca=u.async=ma.extend({r:function(){var a=this,b=a.J=(a.J||0)+1,c=a.state(function(c){if(b>=(a.L||0))return a.L=b,a.k=null,a.query("",c),!0});a.k=c&&c.onAbort},abortPrevious:function(){this.k&&this.k()},F:1E3}),Ha=1,Ia=G.base=r.extend({e:!0,h:!0,model:r,add:function(a){function b(){d.increment("size",-1);k=!0;c()}function c(){null!=f&&(d.unset(f,null),d.trigger("change:"+f),delete d.g[f]);
if(!k){var a=e.queryId();null==a&&(a="__unidentified"+Ha++);a="#"+a;d.query(a,e);d.trigger("change:"+a);d.g[a]=b;f=a}}var d=this,e,f;A(a)?e=a:(e=d.model.make(),e.query("",a));var k;d.increment("size");t(c)},remove:function(a){a="#"+(A(a)?a.queryId():a);if(this.g[a])this.g[a]()}});k.collections=G;var ua={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};u.ajax=ca.extend({state:function(a){function b(){d&&(v--,d=null,c.onComplete())}var c=this,d,e=c.url();null!=e&&e!==c.m&&(c.m=
e,c.abortPrevious(),c.clearOnFetch&&c.clear(),ta(c,{dataType:"text",success:function(b){a(c.parse(b))&&(c.postFetch(),c.trigger("fetch"))},complete:b,beforeSend:function(a){v++;d=a;a.__tbone__=!0},url:e}));return{R:function(){d&&(d.abort(),b())}}},parse:function(a){return a},ajax:function(){return s.ajax.apply(s,arguments)},postFetch:z,onComplete:z,clearOnFetch:!0,sleepEnabled:!0});u.localStorage=r.extend({initialize:function(){var a=this;a.query("",JSON.parse(localStorage[a.key]||"null"));t(function(){localStorage[a.key]=
JSON.stringify(a.S(""))})}});u.location=r.extend({initialize:function(){var a=this;s(window).bind("hashchange",function(){a("hash",location.hash)});a("hash",location.hash);a(function(){var b=a("hash");location.hash!==b&&(location.hash=b)})}});G.localStorage=Ia.extend({initialize:function(){var a=this,b=JSON.parse(localStorage[a.key]||"null");e.each(b||[],function(b){a.add(b)});t(function(){localStorage[a.key]=JSON.stringify(a.query())})}});var ya=/<%(=|-|@|)([\s\S]+?)%>/g,Aa=RegExp("function \\( ([\\w$_]* (, [\\w$_]+)*)  \\)|(\\{)|(\\})|([\\s\\S])".replace(/ /g,
"[\\s\\n]*"),"g"),Ba=/[\w$_]+/g,za=/([^'"]+)('[^']+'|"[^"]+")?/g,wa=RegExp("(\\. )?(([\\w$_]+)(\\.[\\w$_]+)*)".replace(/ /g,"[\\s\\n]*"),"g"),aa={};e.each("break case catch continue debugger default delete do else finally for function if in instanceof new return switch this throw try typeof var void while with Array Boolean Date Function Iterator Number Object RegExp String isFinite isNaN parseFloat parseInt Infinity JSON Math NaN undefined true false null $ _ tbone T view window".split(" "),function(a){aa[a]=
!0});var Q={},na=0,ba=r={make:function(a){var b={};e.extend(b,this);b.initialize(a);return b},extend:function(a){return e.extend({},this,a,{B:this})},$:function(a){return this.$el.find(a)},u:!0,initialize:function(a){y(this);e.extend(this,a);this.$el=s(this.el);this.el.view=this;this.b=this.d?this.d.b-1:2E3;this.scope=t(this.render,this.b,this,"view_"+this.Name,this.f,this,!0)},f:function(){},destroy:function(){var a=this;a.l=!0;a.scope.destroy();e.each(a.p||[],function(b){b.destroy(a)});a.destroyDOM(a.$el)},
render:function(){var a=this,b,c,d,g,f;if(!a.l){na++;if(a.q){b=document.activeElement;if(e.contains(s(b).parents(),a.el)){c="input";d=e.indexOf(a.$(c),b);try{g=b.selectionStart,f=b.selectionEnd}catch(k){}}b=s("<div>").append(this.$el.children());var h=Ca(a.q,a);a.$el.html(h)}a.ready();a.postReady();h=a.p||[];a.p=la(a.$("[tbone]"),a,h);h=e.difference(h,a.p);e.each(h,function(b){b.destroy(a)});if(a.q&&(a.destroyDOM(b),c&&(c=a.$(c)[d]))&&(s(c).focus(),null!=g&&null!=f))try{c.selectionStart=g,c.selectionEnd=
f}catch(l){}Ea++;na--}},ready:z,postReady:z,destroyDOM:function(){},root:function(){return this.query(1)},query:function(a,b,c){var d=!1;"number"!==typeof a&&(c=b,b=a,a=0,d=2===arguments.length);b=(this.D?this.D+".":"")+(b||"");return d?this.C(a,b,c):this.C(a,b)},parentRoot:function(){return this.d&&this.d.root()},parent:function(){return this.d},getHashId:function(a){if(!A(a)){var b=k.make();b.query("",a);a=b}if(!a.n){for(var b=[],c=20;c;c--)b.push("0123456789ABCDEF".charAt(Math.floor(16*Math.random())));
a.n=b.join("")}Q[a.n]=a;return a.n},isQueryable:A,denullText:R},Da=/[^\w.]*([\w.]+)[^\w.]+([\w.]+)/g;k.views=P;k.templates=K;k.createView=function(a,b,c,d){var g=[].slice.call(arguments),f=g.shift();"string"===typeof f?(a=f,f=g.shift()):a="v"+ga++;f&&f.extend?(b=f,f=g.shift()):b=ba;"function"===typeof f?(c=f,f=g.shift()):c=null;d=e.extend({},f||{},{Name:a});var k=b.ready;c&&(d.ready=k===z?c:function(){k.call(this);c.call(this)});return P[a]=b.extend(d)};k.setDefaultView=function(a){ba=a};k.addTemplate=
function(a,b){K[a]=b};k.dontPatch=function(a){aa[a]=!0};k.render=la;k.denullText=R;k.priority={highest:1E4,bound:3E3,beforeViews:2500,view:2E3,afterViews:1500,async:1E3,lowest:0};P.base=r;try{m.dispatchEvent(new m.CustomEvent("tbone_loaded"))}catch(Ja){}if(r=m.Backbone){var oa=function(a,b,c){var d=1===a,g=2===a,f=7===a,k=3===arguments.length,h=f||k;"number"!==typeof a&&(c=b,b=a,a=0,2===arguments.length&&(k=h=!0));b=(b||"").replace(/\.?(__self__)?\.?$/,"");var l=b.split("."),m;h&&(m=l[l.length-1]);
for(var n,q=d&&!b?this:this.e?this.models:this.attributes,r=[],s=l[0]||"",u=b?q[s]:q,t,v;null!=(t=l.shift());)if(""!==t)if(r.push(t),n=q,q=q[t],null==q)if(h)q=Z.exec(l[0])?[]:{},n[t]=q;else break;else if(A(q)){v=!0;break}!h&&w&&(r=y(this),w[r]||(w[r]={obj:this,props:{}}),w[r].props[s]=u);if(v&&(!d||l.length))return k?q.query(a,l.join("."),c):q.query(a,l.join("."));if(h){if(null==n)if(this.e)this.reset(null!=c?c:[]);else if(c){for(var x in this.toJSON())void 0===c[x]&&this.unset(x);this.set(c)}else this.clear();
else f?c=n[m]=!q:n[m]!==c&&(n[m]=c),s&&this.trigger("change:"+s),this.trigger("change");return c}q&&!g&&this.e&&""===b&&(q=e.map(q,function(a){return a.query()}));return q},ca=r.Model.extend({h:!0,initialize:function(){var a=this;y(a);var b=(a.a=a.t())?1E3:3E3;ia({execute:function(){a.scope=t(a.update,b,a,"model_"+a.Name,a.f,a)},b:b+5E3})},t:function(){return!!this._url},f:function(){},reset:function(){this.scope&&this.scope.trigger()},isVisible:function(){return ea(this)},update:function(){this.t()?
this.K():this.M()},K:function(){function a(){c===b.j&&(v--,delete b.j)}var b=this,c,d=b.url(),e=b.m;b.a=!this.isVisible();b.a?b.a=!0:null!=d&&d!==e&&(b.m=d,b.clearOnFetch&&b.clear(),b.fetch({dataType:"text",success:function(){b.postFetch();b.trigger("fetch");b.toJSON()},complete:a,beforeSend:function(d){b.j&&(b.j.abort(),a());v++;c=b.j=d;d.__tbone__=!0},url:d}))},M:function(){this.state&&(this.query("",this.state()),this.toJSON())},state:null,postFetch:z,clearOnFetch:!0});e.each([r.Model.prototype,
r.Collection.prototype],function(a){e.extend(a,{isBackbone:!0,query:oa,text:J,lookup:oa,lookupText:J,c:function(a){this.a&&(this.trigger("wake"),this.a=!1,this.reset());e.each(this.scope&&this.scope.o||[],function(b){(b=b.obj)&&!a[y(b)]&&(a[y(b)]=!0,b.c(a))})}});var b=a.on;a.on=function(){this.c({});return b.apply(this,arguments)}});u=u.bbbase=ca;G=G.bbbase=r.Collection.extend({e:!0});e.each([u,G],function(a){e.extend(a.prototype,{_validate:function(){return!0}})})}})();
