(function(){function t(){}function H(a){return null!==a&&"object"===typeof a&&!E(a)}function E(a){return!!(a&&a.getTimezoneOffset&&a.setUTCFullYear)}function z(a){return!(!a||"function"!==typeof a.query)}function Q(a){return"string"===typeof a||"number"===typeof a&&!isNaN(a)||E(a)||"boolean"===typeof a?a+"":""}function pa(a){var b=[];e.each(e.values(a._callbacks||{}),function(a){for(a=a.next;;)if(a.context)b.push(a.context),a=a.next;else break});e.each(e.flatten(e.values(a._events||{})),function(a){a.context&&
b.push(a.context)});if(z(a)&&"function"===typeof a){a=[a._events];for(var c,d,g;c=a.pop();)for(g in c)if(""===g){d=c[""];for(var f in d)b.push(d[f])}else a.push(c[g])}return e.uniq(b)}function da(a){var b=[a];for(a=[a];b.length;)for(var c=b.pop(),c=pa(c),d=0;d<c.length;d++){var g=c[d];g.G&&(g=g.context);if(g){if(g.H)return!0;g.n&&-1===a.indexOf(g)&&(b.push(g),a.push(g))}}return!1}function R(a){return a.replace(/^change:/,"change.").split(qa)}function u(a,b,c,d,g,f,e){b||(b=v?v.b-1:0);!d&&v&&(d=v.N+
"+");a=new ea(a,c,b,d,g,f);!e&&v&&v.h.push(a);a.execute();return a}function ea(a,b,c,d,g,f){e.extend(this,{fn:a,context:b,b:c,Name:d,t:g,I:f,h:[]})}function y(a){return a.tboneid=a.tboneid||fa++}function ra(){S&&(T.sort(function(a,b){return a.b-b.b}),S=!1);return T.pop()}function ga(){U||(U=setTimeout(function(){k.query("__isReady__",sa());k.query("__ajaxReady__",!s);k.query("__numAjaxInFlight__",s);U=null},20))}function ha(a){var b=y(a);V[b]||(V[b]=!0,T.push(a),S=!0,B||(ga(),B=e.defer(W)))}function X(a){return L&&
(a?ia.scrollTop(a):ia.scrollTop())}function W(){Y=!1;var a=X();B=null;for(var b,c=5E3;--c&&(b=ra());)delete V[y(b)],b.execute();c||(B=e.defer(W));ga();a&&!Y&&a!==X()&&X(a)}function I(a,b,c,d,g,f,e){if(16<f)return!0;b=b||{};if(z(d)||z(c))e=!0;var l=e,h;for(h in b)""===h?d!==c&&(H(d)&&H(c)?g=!0:l=E(d)&&E(c)?d.getTime()!==c.getTime()||l:!0):l=I(a,b[h],c&&c[h],d&&d[h],!1,f+1,e)||l;if(g&&!l)if(H(d)&&H(c)){e={};var k=[d,c];for(g=0;2>g&&!l;g++){var F=k[g];if("[object Array]"===ka.call(F))for(d.length!==
c.length&&(l=!0),h=0;h<F.length&&!l;h++)e[h]||(e[h]=!0,I(a,b[h],c[h],d[h],!0,f+1,!1)&&(l=!0));else for(h in F)if(!e[h]&&(e[h]=!0,I(a,b[h],c[h],d[h],!0,f+1,!1))){l=!0;break}}}else E(d)&&E(c)?l=d.getTime()!==c.getTime():d!==c&&(l=!0);if(l){a=b[""]||{};for(var p in a)a[p].trigger.call(a[p])}return l}function M(a,b,c){var d=1===a,g=2===a,f=3===a,k=4===a,l=5===a,h=6===a,ja=7===a,F=9===a,p=f||k||l||h,N=8===a,n=10===a,t=3===arguments.length,D=p||ja||N||t||F;"number"!==typeof a&&(c=b,b=a,a=0,2===arguments.length&&
(t=D=!0));b=(b||"").replace("__self__","");var C=b.split("."),x=[],A;for(A=0;A<C.length;A++)C[A]&&x.push(C[A]);C=x[x.length-1]||"attributes";A=this;for(var m=d&&!b?this:this.attributes,r=[],q,v,u={},s=D&&this._events.change;;){if(null==m&&!D){r=r.concat(x);break}else if(m!==this&&z(m)){v=x.length||(D?!N&&!z(c):!d);break}else if(D&&!H(m)&&(x.length||p)){if(N)return;m=(x.length?Z.exec(x[0]):p)?[]:{};this.query(r.join("."),m)}q=x.shift();if(null==q)break;r.push(q);A=m;m=m[q];s&&(e.extend(u,s[""]||{}),
s=s[q])}!D&&w&&(d=y(this),w[d]||(w[d]={obj:this,props:{}}),w[d].props[r.join(".")]=m);if(v)return t?m.query(a,x.join("."),c):m.query(a,x.join("."));if(D){f?m.push(c):k?m.unshift(c):l?m.shift(c):h?m.pop(c):N?delete A[C]:ja?c=A[C]=!m:F?c=A[C]=(m||0)+c:A[C]=c;if(e.isEmpty(u))I(this,s,m,c,!1,0,n);else if(I(this,s,m,c,!0,0,n))for(var B in u)u[B].trigger.call(u[B]);return c}!g&&this.e&&""===b&&("[object Array]"===ka.call(m)?m=e.map(m,function(a){return a.query()}):m&&(m=e.reduce(e.keys(m),function(a,b){z(m[b])&&
(a[b]=m[b].query());return a},{})));return m}function J(a,b){return Q(null==b?this.query(a):this.query(a,b))}function ta(a,b){var c=ua.read;e.defaults(b||(b={}),{emulateHTTP:k.emulateHTTP,emulateJSON:k.emulateJSON});var d={type:c,dataType:"json"};b.url||(d.url=e.result(a,"url")||urlError());b.emulateJSON&&(d.contentType="application/x-www-form-urlencoded",d.data=d.data?{model:d.data}:{});if(b.emulateHTTP&&("PUT"===c||"DELETE"===c||"PATCH"===c)){d.type="POST";b.emulateJSON&&(d.data.O=c);var g=b.F;
b.F=function(a){a.setRequestHeader("X-HTTP-Method-Override",c);if(g)return g.apply(this,arguments)}}"GET"===d.type||b.emulateJSON||(d.processData=!1);"PATCH"!==d.type||!window.ActiveXObject||window.external&&window.external.P||(d.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});b.xhr=a.ajax(e.extend(d,b))}function va(a,b){return a.replace(wa,function(a,d,g,f){return aa[f]||d||Z.test(f)?a:null!=b[f]?["(",f," && view.isQueryable(",f,") ? ",f,'.query("',g.slice(f.length+1),'") : ',g,")"].join(""):
['view.query(2, "',g,'")'].join("")})}function xa(a){function b(){d=e.invert(e.flatten(c))}var c=[[]],d={};b();a=a.replace(ya,function(a,f,e){function l(){var a=va(h.join(""),d);h=[];return a}var h=[];(a="@"===f)&&(f="");e=e.replace(za,function(a,d,g){return d.replace(Aa,function(a,d,g,f,e,k){if(k)return h.push(k),"";f?c.push([]):d?d.replace(Ba,function(a){c[c.length-1].push(a)}):e&&c.pop();b();return l()+a})+l()+(g||"")})+l();return"<%"+(a?"= view.getHashId("+e+") ":f?f+"view.denullText("+e+")":
e)+"%>"});return e.template(a,null,{variable:"view"})}function Ca(a,b){var c=K[a];if(null==c&&(c=$('script[name="'+a+'"]').html(),!c))return"";"string"===typeof c&&(c=K[a]=xa(c));return c(b)}function la(a,b,c){var d={};e.each(c||[],function(a){(d[a.u]=d[a.u]||[]).push(a)});return e.map(a,function(a){var c=$(a),e=a.outerHTML;if(d[e]&&d[e].length)return a=d[e].shift(),c.replaceWith(a.el),a;var l={};(c.attr("tbone")||"").replace(Da,function(a,b,c){l[b]=c});var h=l.inline;if(h){var n=c.html().replace(/&lt;/g,
"<").replace(/&gt;/g,">").replace(/&amp;/g,"&");K[h]=n}var r=h||l.tmpl,h=l.root,p=l.view||r,n=O[p]||ba;c.addClass(p);for(var q=n.v;q&&q.Name;)c.addClass(q.Name),q=q.v;c={Name:p,u:e,el:a,C:r,d:b,w:P[h]||k,A:P[h]?"":h};delete P[h];return n.make(c)})}var r,e;"undefined"!==typeof exports?(e=require("underscore")._,r=exports):(r=window,e=r._);var q={},G={},K={},O={},ka=Object.prototype.toString,Z=/^\d+$/,Ea=0,qa=/[.]+/,n={n:!0,make:function(a){function b(a,d,g){return"function"===typeof a?u(a,d):"function"!==
typeof d||z(d)?0===arguments.length?b.query():1===arguments.length?b.query(a):2===arguments.length?b.query(a,d):b.query(a,d,g):b.query(a,ma.extend({state:d}).make())}e.extend(b,this,"function"===typeof a?{state:a}:a||{});delete b.tboneid;delete b.attributes;b._events={};b.g={};y(b);b.initialize();return b},extend:function(a){return e.extend({},this,a)},initialize:t,on:function(a,b,c){b=R(a);a=this._events;for(var d;null!=(d=b.shift());)""!==d&&(a[d]||(a[d]={}),a=a[d]);(b=a[""])||(b=a[""]={});a=y(c);
b[a]=c;this.c({})},off:function(a,b,c){a=R(a);b=this._events;for(var d;null!=(d=a.shift());)""!==d&&(b[d]||(b[d]={}),b=b[d]);if(a=b[""])c=y(c),delete a[c]},trigger:function(a){var b=this._events;a=R(a);for(var c;null!=(c=a.shift());)""!==c&&(b[c]||(b[c]={}),b=b[c]);var b=b[""]||{},d;for(d in b)b[d].trigger.call(b[d])},runOnlyOnce:function(a){var b;u(function(){b||a()});b=!0},query:M,queryModel:function(a){return this.query(1,a)},readSilent:function(a){var b=w;w=null;a=this.query(a);w=b;return a},
idAttribute:"id",queryId:function(){return this.query(this.idAttribute)},toggle:function(a){this.query(7,a)},push:function(a,b){1===arguments.length&&(b=a,a="");this.query(3,a,b)},unshift:function(a,b){1===arguments.length&&(b=a,a="");this.query(4,a,b)},removeFirst:function(a){this.query(5,a)},removeLast:function(a){this.query(6,a)},unset:function(a){this.query(8,a)},increment:function(a,b){this.query(9,a,null!=b?b:1)},clear:function(){this.query("",void 0)},toJSON:function(){return this.attributes},
c:t,queryText:J,text:J,lookup:M,lookupText:J,set:M,get:M},k=n.make({Name:"tbone"}),Fa=r.tbone,Ga=r.T;r.tbone=k;r.T=k;k.noConflict=function(){r.T=Ga;r.tbone=Fa};k.models=q;q.base=n;var v,w;e.extend(ea.prototype,{G:!0,trigger:function(){ha(this)},execute:function(){var a=this;if(!a.k){a.D();a.r();var b=w;this.o=w={};var c=v;v=a;try{a.fn.call(a.context)}catch(d){k.push("__errors__."+a.Name,(d&&d.stack||d)+"")}e.each(w,function(b){var c=b.obj;b=b.props;if(b[""])c.on("change",a.trigger,a);else for(var d in b)c.on("change:"+
d,a.trigger,a)});a.t&&a.t.call(a.I,this);w=b;v=c}},D:function(){var a=this.o||{},b;for(b in a){var c=a[b],d=c.obj,c=c.props,e;for(e in c)d.off("change:"+e,null,this)}},r:function(){for(var a=0;a<this.h.length;a++)this.h[a].destroy();this.h=[]},destroy:function(){this.k=!0;this.D();this.r()}});var fa=1,T=[],S,V={},B,s=0,sa=k.isReady=function(){return!s&&!B},U,L=this.$&&$.fn&&$.fn.scrollTop,ia=L&&$(window),Y;L&&($.fn.scrollTop=function(a){a&&(Y=!0);return L.apply(this,arguments)});k.drain=function(){B&&
clearTimeout(B);W()};var ma=q.bound=n.extend({initialize:function(){this.scope=u(this.update,this.B,this,this.Name&&"model_"+this.Name,this.f,this,!0)},B:3E3,c:function(a){this.a&&(this.a=!1,this.reset());e.each(this.scope&&this.scope.o||[],function(b){(b=b.obj)&&!a[y(b)]&&(a[y(b)]=!0,b.c(a))})},f:function(){},update:function(){(this.a=this.sleepEnabled&&!da(this))||this.q()},q:function(){this.query(this.assumeChanged?10:0,"",this.state())},reset:function(){this.scope&&this.scope.trigger()},destroy:function(){this.scope&&
this.scope.destroy();this.unset("")},state:t,sleepEnabled:!1}),ca=q.async=ma.extend({q:function(){var a=this,b=a.J=(a.J||0)+1,c=a.state(function(c){if(b>=(a.L||0))return a.L=b,a.j=null,a.query("",c),!0});a.j=c&&c.onAbort},abortPrevious:function(){this.j&&this.j()},B:1E3}),Ha=1,Ia=G.base=n.extend({e:!0,n:!0,model:n,add:function(a){function b(){d.increment("size",-1);k=!0;c()}function c(){null!=f&&(d.unset(f,null),d.trigger("change:"+f),delete d.g[f]);if(!k){var a=e.queryId();null==a&&(a="__unidentified"+
Ha++);a="#"+a;d.query(a,e);d.trigger("change:"+a);d.g[a]=b;f=a}}var d=this,e,f;z(a)?e=a:(e=d.model.make(),e.query("",a));var k;d.increment("size");u(c)},remove:function(a){a="#"+(z(a)?a.queryId():a);if(this.g[a])this.g[a]()}});k.collections=G;var ua={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};q.ajax=ca.extend({state:function(a){function b(){d&&(s--,d=null,c.onComplete())}var c=this,d,e=c.url();null!=e&&e!==c.l&&(c.l=e,c.abortPrevious(),c.clearOnFetch&&c.clear(),ta(c,{dataType:"text",
success:function(b){a(c.parse(b))&&(c.postFetch(),c.trigger("fetch"))},complete:b,beforeSend:function(a){s++;d=a;a.__tbone__=!0},url:e}));return{Q:function(){d&&(d.abort(),b())}}},parse:function(a){return a},ajax:function(){return $.ajax.apply($,arguments)},postFetch:t,onComplete:t,clearOnFetch:!0,sleepEnabled:!0});q.localStorage=n.extend({initialize:function(){var a=this;a.query("",JSON.parse(localStorage[a.key]||"null"));u(function(){localStorage[a.key]=JSON.stringify(a.R(""))})}});q.location=n.extend({initialize:function(){var a=
this;$(window).bind("hashchange",function(){a("hash",location.hash)});a("hash",location.hash);a(function(){var b=a("hash");location.hash!==b&&(location.hash=b)})}});G.localStorage=Ia.extend({initialize:function(){var a=this,b=JSON.parse(localStorage[a.key]||"null");e.each(b||[],function(b){a.add(b)});u(function(){localStorage[a.key]=JSON.stringify(a.query())})}});var ya=/<%(=|-|@|)([\s\S]+?)%>/g,Aa=RegExp("function \\( ([\\w$_]* (, [\\w$_]+)*)  \\)|(\\{)|(\\})|([\\s\\S])".replace(/ /g,"[\\s\\n]*"),
"g"),Ba=/[\w$_]+/g,za=/([^'"]+)('[^']+'|"[^"]+")?/g,wa=RegExp("(\\. )?(([\\w$_]+)(\\.[\\w$_]+)*)".replace(/ /g,"[\\s\\n]*"),"g"),aa={};e.each("break case catch continue debugger default delete do else finally for function if in instanceof new return switch this throw try typeof var void while with Array Boolean Date Function Iterator Number Object RegExp String isFinite isNaN parseFloat parseInt Infinity JSON Math NaN undefined true false null $ _ tbone T view window".split(" "),function(a){aa[a]=
!0});var P={},na=0,ba=n={make:function(a){var b={};e.extend(b,this);b.initialize(a);return b},extend:function(a){return e.extend({},this,a,{v:this})},$:function(a){return this.$el.find(a)},H:!0,initialize:function(a){y(this);e.extend(this,a);this.$el=$(this.el);this.el.view=this;this.b=this.d?this.d.b-1:2E3;this.scope=u(this.render,this.b,this,"view_"+this.Name,this.f,this,!0)},f:function(){},destroy:function(){var a=this;a.k=!0;a.scope.destroy();e.each(a.p||[],function(b){b.destroy(a)});a.destroyDOM(a.$el)},
render:function(){var a=this;if(!a.k){na++;if(a.C){var b=document.activeElement,c,d,g,f;if(e.contains($(b).parents(),a.el)){c="input";d=e.indexOf(a.$(c),b);try{g=b.selectionStart,f=b.selectionEnd}catch(k){}}var b=$("<div>").append(this.$el.children()),l=Ca(a.C,a);a.$el.html(l);a.ready();a.postReady();l=a.p||[];a.p=la(a.$("[tbone]"),a,l);l=e.difference(l,a.p);e.each(l,function(b){b.destroy(a)});a.destroyDOM(b);if(c&&(c=a.$(c)[d])&&($(c).focus(),null!=g&&null!=f))try{c.selectionStart=g,c.selectionEnd=
f}catch(h){}}else a.ready(),a.postReady();a.postRender();Ea++;na--}},ready:t,postReady:t,postRender:t,destroyDOM:function(){},root:function(){return this.query(1)},query:function(a,b,c){var d=!1;"number"!==typeof a&&(c=b,b=a,a=0,d=2===arguments.length);b=(this.A?this.A+".":"")+(b||"");return d?this.w(a,b,c):this.w(a,b)},parentRoot:function(){return this.d&&this.d.root()},parent:function(){return this.d},getHashId:function(a){if(!z(a)){var b=k.make();b.query("",a);a=b}if(!a.m){for(var b=[],c=20;c;c--)b.push("0123456789ABCDEF".charAt(Math.floor(16*
Math.random())));a.m=b.join("")}P[a.m]=a;return a.m},isQueryable:z,denullText:Q},Da=/[^\w.]*([\w.]+)[^\w.]+([\w.]+)/g;k.views=O;k.templates=K;k.createView=function(a,b,c,d){var g=[].slice.call(arguments),f=g.shift();"string"===typeof f?(a=f,f=g.shift()):a="v"+fa++;f&&f.extend?(b=f,f=g.shift()):b=ba;"function"===typeof f?(c=f,f=g.shift()):c=null;d=e.extend({},f||{},{Name:a});var k=b.ready;c&&(d.ready=k===t?c:function(){k.call(this);c.call(this)});return O[a]=b.extend(d)};k.setDefaultView=function(a){ba=
a};k.addTemplate=function(a,b){K[a]=b};k.dontPatch=function(a){aa[a]=!0};k.render=la;k.denullText=Q;k.priority={highest:1E4,bound:3E3,beforeViews:2500,view:2E3,afterViews:1500,async:1E3,lowest:0};O.base=n;try{dispatchEvent(new CustomEvent("tbone_loaded"))}catch(Ja){}if(n=r.Backbone){var oa=function(a,b,c){var d=1===a,g=2===a,f=7===a,k=3===arguments.length,l=f||k;"number"!==typeof a&&(c=b,b=a,a=0,2===arguments.length&&(k=l=!0));b=(b||"").replace(/\.?(__self__)?\.?$/,"");var h=b.split("."),q;l&&(q=
h[h.length-1]);for(var n,p=d&&!b?this:this.e?this.models:this.attributes,r=[],t=h[0]||"",u=b?p[t]:p,s,v;null!=(s=h.shift());)if(""!==s)if(r.push(s),n=p,p=p[s],null==p)if(l)p=Z.exec(h[0])?[]:{},n[s]=p;else break;else if(z(p)){v=!0;break}!l&&w&&(r=y(this),w[r]||(w[r]={obj:this,props:{}}),w[r].props[t]=u);if(v&&(!d||h.length))return k?p.query(a,h.join("."),c):p.query(a,h.join("."));if(l){if(null==n)if(this.e)this.reset(null!=c?c:[]);else if(c){for(var x in this.toJSON())void 0===c[x]&&this.unset(x);
this.set(c)}else this.clear();else f?c=n[q]=!p:n[q]!==c&&(n[q]=c),t&&this.trigger("change:"+t),this.trigger("change");return c}p&&!g&&this.e&&""===b&&(p=e.map(p,function(a){return a.query()}));return p},ca=n.Model.extend({n:!0,initialize:function(){var a=this;y(a);var b=(a.a=a.s())?1E3:3E3;ha({execute:function(){a.scope=u(a.update,b,a,"model_"+a.Name,a.f,a)},b:b+5E3})},s:function(){return!!this._url},f:function(){},reset:function(){this.scope&&this.scope.trigger()},isVisible:function(){return da(this)},
update:function(){this.s()?this.K():this.M()},K:function(){function a(){c===b.i&&(s--,delete b.i)}var b=this,c,d=b.url(),e=b.l;b.a=!this.isVisible();b.a?b.a=!0:null!=d&&d!==e&&(b.l=d,b.clearOnFetch&&b.clear(),b.fetch({dataType:"text",success:function(){b.postFetch();b.trigger("fetch");b.toJSON()},complete:a,beforeSend:function(d){b.i&&(b.i.abort(),a());s++;c=b.i=d;d.__tbone__=!0},url:d}))},M:function(){this.state&&(this.query("",this.state()),this.toJSON())},state:null,postFetch:t,clearOnFetch:!0});
e.each([n.Model.prototype,n.Collection.prototype],function(a){e.extend(a,{isBackbone:!0,query:oa,text:J,lookup:oa,lookupText:J,c:function(a){this.a&&(this.trigger("wake"),this.a=!1,this.reset());e.each(this.scope&&this.scope.o||[],function(b){(b=b.obj)&&!a[y(b)]&&(a[y(b)]=!0,b.c(a))})}});var b=a.on;a.on=function(){this.c({});return b.apply(this,arguments)}});q=q.bbbase=ca;G=G.bbbase=n.Collection.extend({e:!0});e.each([q,G],function(a){e.extend(a.prototype,{_validate:function(){return!0}})})}})();
