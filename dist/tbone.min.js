(function(){function z(){}function H(a){return null!==a&&"object"===typeof a&&!E(a)}function E(a){return!!(a&&a.getTimezoneOffset&&a.setUTCFullYear)}function A(a){return!(!a||"function"!==typeof a.query)}function R(a){return"string"===typeof a||"number"===typeof a&&!isNaN(a)||E(a)||"boolean"===typeof a?a+"":""}function ra(a){var b=[];e.each(e.values(a._callbacks||{}),function(a){for(a=a.next;;)if(a.context)b.push(a.context),a=a.next;else break});e.each(e.flatten(e.values(a._events||{})),function(a){a.context&&
b.push(a.context)});if(A(a)&&"function"===typeof a){a=[a._events];for(var c,d,f;c=a.pop();)for(f in c)if(""===f){d=c[""];for(var h in d)b.push(d[h])}else a.push(c[f])}return e.uniq(b)}function fa(a){var b=[a];for(a=[a];b.length;)for(var c=b.pop(),c=ra(c),d=0;d<c.length;d++){for(var f=c[d];f&&!f.u&&!f.h;)f=f.A||f.context;if(f){if(f.u)return!0;f.h&&-1===a.indexOf(f)&&(b.push(f),a.push(f))}}return!1}function S(a){return a.replace(/^change:/,"change.").split(sa)}function t(a,b,c,d,f,h,e){null==b&&(b=
s?s.b-1:4E3);!d&&s&&(d=s.R+"+");a=new ga(a,c,b,d,f,h);!e&&s&&(s.i.push(a),a.A=s);a.execute();return a}function ga(a,b,c,d,f,h){e.extend(this,{fn:a,context:b,b:c,Name:d,v:f,K:h,i:[]})}function y(a){return a.tboneid=a.tboneid||ha++}function ta(){U&&(M.sort(function(a,b){return a.b-b.b}),U=!1);return M.pop()}function ia(){V||(V=setTimeout(function(){k.query("__isReady__",ua());k.query("__ajaxReady__",!v);k.query("__numAjaxInFlight__",v);V=null},20))}function ja(a){var b=y(a);W[b]||(W[b]=!0,M.push(a),
U=!0,C||(ia(),C=e.defer(X)))}function Y(a){return N&&(a?ka.scrollTop(a):ka.scrollTop())}function X(){Z=!1;var a=Y(),b;C=null;C=M.length?e.defer(X):null;for(var c=5E3;--c&&(b=ta());)delete W[y(b)],b.execute();ia();a&&!Z&&a!==Y()&&Y(a)}function J(a,b,c,d,f,h,e){if(16<h)return!0;b=b||{};if(A(d)||A(c))e=!0;var g=e,l;for(l in b)""===l?d!==c&&(H(d)&&H(c)?f=!0:g=E(d)&&E(c)?d.getTime()!==c.getTime()||g:!0):g=J(a,b[l],c&&c[l],d&&d[l],!1,h+1,e)||g;if(f&&!g)if(H(d)&&H(c)){e={};var k=[d,c];for(f=0;2>f&&!g;f++){var D=
k[f];if("[object Array]"===la.call(D))for(d.length!==c.length&&(g=!0),l=0;l<D.length&&!g;l++)e[l]||(e[l]=!0,J(a,b[l],c[l],d[l],!0,h+1,!1)&&(g=!0));else for(l in D)if(!e[l]&&(e[l]=!0,J(a,b[l],c[l],d[l],!0,h+1,!1))){g=!0;break}}}else E(d)&&E(c)?g=d.getTime()!==c.getTime():d!==c&&(g=!0);if(g){a=b[""]||{};for(var r in a)a[r].trigger.call(a[r])}return g}function O(a,b,c){var d=3===arguments.length;"number"!==typeof a&&(c=b,b=a,a=0,2===arguments.length&&(d=!0));var f=1===a,h=2===a,I=3===a,g=4===a,l=5===
a,k=6===a,D=7===a,r=9===a,aa=I||g||l||k,q=8===a,n=10===a,F=aa||D||q||d||r;b=(b||"").replace("__self__","");var m=b.split("."),x=[],B;for(B=0;B<m.length;B++)m[B]&&x.push(m[B]);m=x[x.length-1]||"attributes";B=this;for(var p=f&&!b?this:this.attributes,s=[],u,z,t={},v=F&&this._events.change;;){if(null==p&&!F){s=s.concat(x);break}else if(p!==this&&A(p)){z=x.length||(F?!q&&!A(c):!f);break}else if(F&&!H(p)&&(x.length||aa)){if(q)return;p=(x.length?ba.exec(x[0]):aa)?[]:{};this.query(s.join("."),p)}u=x.shift();
if(null==u)break;s.push(u);B=p;p=p[u];v&&(e.extend(t,v[""]||{}),v=v[u])}!F&&w&&(f=y(this),w[f]||(w[f]={obj:this,props:{}}),w[f].props[s.join(".")]=p);if(z)return d?p.query(a,x.join("."),c):p.query(a,x.join("."));if(F){I?p.push(c):g?p.unshift(c):l?p.shift(c):k?p.pop(c):q?delete B[m]:D?c=B[m]=!p:r?c=B[m]=(p||0)+c:B[m]=c;if(e.isEmpty(t))J(this,v,p,c,!1,0,n);else if(J(this,v,p,c,!0,0,n))for(var C in t)t[C].trigger.call(t[C]);return c}!h&&this.e&&""===b&&("[object Array]"===la.call(p)?p=e.map(p,function(a){return a.query()}):
p&&(p=e.reduce(e.keys(p),function(a,b){A(p[b])&&(a[b]=p[b].query());return a},{})));return p}function K(a,b){return R(null==b?this.query(a):this.query(a,b))}function va(a,b){var c=wa.read;e.defaults(b||(b={}),{emulateHTTP:k.emulateHTTP,emulateJSON:k.emulateJSON});var d={type:c};b.url||(d.url=e.result(a,"url"));b.emulateJSON&&(d.contentType="application/x-www-form-urlencoded",d.data=d.data?{model:d.data}:{});if(b.emulateHTTP&&("PUT"===c||"DELETE"===c||"PATCH"===c)){d.type="POST";b.emulateJSON&&(d.data.S=
c);var f=b.I;b.I=function(a){a.setRequestHeader("X-HTTP-Method-Override",c);if(f)return f.apply(this,arguments)}}"GET"===d.type||b.emulateJSON||(d.processData=!1);"PATCH"!==d.type||!window.ActiveXObject||window.external&&window.external.V||(d.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});b.xhr=a.ajax(e.extend(d,b))}function ma(a){return function(b){window.history[a+"State"]({},"",b);q(window).trigger(a+"state")}}function xa(a,b){return a.replace(ya,function(a,d,f,h){return ca[h]||
d||ba.test(h)?a:null!=b[h]?["(",h," && view.isQueryable(",h,") ? ",h,'.query("',f.slice(h.length+1),'") : ',f,")"].join(""):['view.query(2, "',f,'")'].join("")})}function za(a){function b(){d=e.invert(e.flatten(c))}var c=[[]],d={};b();a=a.replace(Aa,function(a,h,e){function g(){var a=xa(l.join(""),d);l=[];return a}var l=[];(a="@"===h)&&(h="");e=e.replace(Ba,function(a,d,f){return d.replace(Ca,function(a,d,f,h,e,I){if(I)return l.push(I),"";h?c.push([]):d?d.replace(Da,function(a){c[c.length-1].push(a)}):
e&&c.pop();b();return g()+a})+g()+(f||"")})+g();return"<%"+(a?"= view.getHashId("+e+") ":h?h+"view.denullText("+e+")":e)+"%>"});return e.template(a,null,{variable:"view"})}function Ea(a,b){var c=L[a];null==c&&(c=q('script[name="'+a+'"]').html()||"");"string"===typeof c&&(c=L[a]=za(c));return c(b)}function na(a,b,c){var d={};e.each(c||[],function(a){(d[a.w]=d[a.w]||[]).push(a)});return e.map(a,function(a){var c=q(a),e=a.outerHTML,g=a.__tboneview__;if(!g){if(d[e]&&d[e].length)e=d[e].shift(),c.replaceWith(e.el),
g=e;else{var l={};(c.attr("tbone")||"").replace(Fa,function(a,b,c){l[b]=c});if(g=l.inline){var m=c.html().replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&");L[g]=m}var D=g||l.tmpl,g=l.root,r=l.view||D,m=P[r]||da;c.addClass(r);for(var n=m.B;n&&n.Name;)c.addClass(n.Name),n=n.B;c={Name:r,w:e,el:a,q:D,d:b,C:Q[g]||k,D:Q[g]?"":g};delete Q[g];g=m.make(c)}a.__tboneview__=g}return g})}var m,e,q;"undefined"!==typeof exports?(e=require("underscore")._,m=exports):(m=window,e=m._,q=m.$);var u={},
G={},L={},P={},la=Object.prototype.toString,ba=/^\d+$/,Ga=0,sa=/[.]+/,n={h:!0,make:function(a){function b(a,d,f){return"function"===typeof a?t(a,d):"function"!==typeof d||A(d)?0===arguments.length?b.query():1===arguments.length?b.query(a):2===arguments.length?b.query(a,d):b.query(a,d,f):b.query(a,oa.extend({state:d}).make())}e.extend(b,this,"function"===typeof a?{state:a}:a||{});delete b.tboneid;delete b.attributes;b._events={};b.g={};y(b);b.initialize();return b},extend:function(a){return e.extend({},
this,a)},initialize:z,on:function(a,b,c){b=S(a);a=this._events;for(var d;null!=(d=b.shift());)""!==d&&(a[d]||(a[d]={}),a=a[d]);(b=a[""])||(b=a[""]={});a=y(c);b[a]=c;this.c({})},off:function(a,b,c){a=S(a);b=this._events;for(var d;null!=(d=a.shift());)""!==d&&(b[d]||(b[d]={}),b=b[d]);if(a=b[""])c=y(c),delete a[c]},trigger:function(a){var b=this._events;a=S(a);for(var c;null!=(c=a.shift());)""!==c&&(b[c]||(b[c]={}),b=b[c]);var b=b[""]||{},d;for(d in b)b[d].trigger.call(b[d])},runOnlyOnce:function(a){var b;
t(function(){b||a()});b=!0},query:O,queryModel:function(a){return this.query(1,a)},readSilent:function(a){var b=w;w=null;a=this.query(a);w=b;return a},idAttribute:"id",queryId:function(){return this.query(this.idAttribute)},toggle:function(a){this.query(7,a)},push:function(a,b){1===arguments.length&&(b=a,a="");this.query(3,a,b)},unshift:function(a,b){1===arguments.length&&(b=a,a="");this.query(4,a,b)},removeFirst:function(a){this.query(5,a)},removeLast:function(a){this.query(6,a)},unset:function(a){this.query(8,
a)},increment:function(a,b){this.query(9,a,null!=b?b:1)},clear:function(){this.query("",void 0)},toJSON:function(){return this.attributes},c:z,queryText:K,text:K,lookup:O,lookupText:K,set:O,get:O},k=n.make({Name:"tbone"}),Ha=m.tbone,Ia=m.T;m.tbone=k;m.T=k;k.noConflict=function(){m.T=Ia;m.tbone=Ha};k.models=u;u.base=n;var s,w;e.extend(ga.prototype,{U:!0,trigger:function(){ja(this)},execute:function(){var a=this;if(!a.l){a.H();a.s();var b=w;this.o=w={};var c=s;s=a;try{a.fn.call(a.context)}finally{e.each(w,
function(b){var c=b.obj;b=b.props;if(b[""])c.on("change",a.trigger,a);else for(var e in b)c.on("change:"+e,a.trigger,a)}),a.v&&a.v.call(a.K,this),w=b,s=c}}},H:function(){var a=this.o||{},b;for(b in a){var c=a[b],d=c.obj,c=c.props,e;for(e in c)d.off("change:"+e,null,this)}},s:function(){for(var a=0;a<this.i.length;a++)this.i[a].destroy();this.i=[]},destroy:function(){this.l=!0;delete this.A;this.H();this.s()}});var ha=1,M=[],U,W={},C,v=0,ua=k.isReady=function(){return!v&&!C},V,N=this.$&&q.fn&&q.fn.scrollTop,
ka=N&&q(window),Z;N&&(q.fn.scrollTop=function(a){a&&(Z=!0);return N.apply(this,arguments)});k.drain=function(){C&&clearTimeout(C);X()};var oa=u.bound=n.extend({initialize:function(){this.scope=t(this.update,this.F,this,this.Name&&"model_"+this.Name,this.f,this,!0)},F:3E3,c:function(a){this.a&&(this.a=!1,this.reset());e.each(this.scope&&this.scope.o||[],function(b){(b=b.obj)&&!a[y(b)]&&(a[y(b)]=!0,b.c(a))})},f:function(){},update:function(){(this.a=this.sleepEnabled&&!fa(this))||this.r()},r:function(){this.query(this.assumeChanged?
10:0,"",this.state())},reset:function(){this.scope&&this.scope.trigger()},destroy:function(){this.scope&&this.scope.destroy();this.unset("")},disableSleep:function(){},state:z,sleepEnabled:!1}),ea=u.async=oa.extend({r:function(){var a=this,b=a.L=(a.L||0)+1,c=a.state(function(c){if(b>=(a.N||0))return a.N=b,a.k=null,a.query("",c),!0});a.k=c&&c.onAbort},abortPrevious:function(){this.k&&this.k()},F:1E3}),Ja=1,Ka=G.base=n.extend({e:!0,h:!0,model:n,add:function(a){function b(){d.increment("size",-1);k=
!0;c()}function c(){null!=h&&(d.unset(h,null),d.trigger("change:"+h),delete d.g[h]);if(!k){var a=e.queryId();null==a&&(a="__unidentified"+Ja++);a="#"+a;d.query(a,e);d.trigger("change:"+a);d.g[a]=b;h=a}}var d=this,e,h;A(a)?e=a:(e=d.model.make(),e.query("",a));var k;d.increment("size");t(c)},remove:function(a){a="#"+(A(a)?a.queryId():a);if(this.g[a])this.g[a]()}});k.collections=G;var wa={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};u.ajax=ea.extend({state:function(a){function b(){d&&
(v--,d=null,c.onComplete())}var c=this,d,e=c.url();null!=e&&e!==c.m&&(c.m=e,c.abortPrevious(),c.clearOnFetch&&c.clear(),va(c,{dataType:c.dataType,success:function(b){a(c.parse(b))&&(c.postFetch(),c.trigger("fetch"))},complete:b,beforeSend:function(a){v++;d=a},url:e}));return{W:function(){d&&(d.abort(),b())}}},parse:function(a){return a},ajax:function(){return q.ajax.apply(q,arguments)},postFetch:z,onComplete:z,clearOnFetch:!0,sleepEnabled:!0,dataType:"json"});u.localStorage=n.extend({initialize:function(){var a=
this;a.query("",JSON.parse(localStorage[a.key]||"null"));t(function(){localStorage[a.key]=JSON.stringify(a.X(""))})}});u.location=n.extend({initialize:function(){function a(){c("hash",location.hash)}function b(){c("pathname",location.pathname)}var c=this;q(window).bind("hashchange",a);q(window).bind("popstate pushstate replacestate",b);a();b();c(function(){var a=c("hash");location.hash!==a&&(location.hash=a)});c(function(){var a=c("pathname");location.pathname!==a&&c.pushPath(a)})},pushPath:ma("push"),
replacePath:ma("replace")});G.localStorage=Ka.extend({initialize:function(){var a=this,b=JSON.parse(localStorage[a.key]||"null");e.each(b||[],function(b){a.add(b)});t(function(){localStorage[a.key]=JSON.stringify(a.query())})}});var Aa=/<%(=|-|@|)([\s\S]+?)%>/g,Ca=RegExp("function \\( ([\\w$_]* (, [\\w$_]+)*)  \\)|(\\{)|(\\})|([\\s\\S])".replace(/ /g,"[\\s\\n]*"),"g"),Da=/[\w$_]+/g,Ba=/([^'"]+)('[^']+'|"[^"]+")?/g,ya=RegExp("(\\. )?(([\\w$_]+)(\\.[\\w$_]+)*)".replace(/ /g,"[\\s\\n]*"),"g"),ca={};
e.each("break case catch continue debugger default delete do else finally for function if in instanceof new return switch this throw try typeof var void while with Array Boolean Date Function Iterator Number Object RegExp String isFinite isNaN parseFloat parseInt Infinity JSON Math NaN undefined true false null $ _ tbone T view window".split(" "),function(a){ca[a]=!0});var Q={},pa=0,da=n={make:function(a){var b={};e.extend(b,this);b.initialize(a);return b},extend:function(a){return e.extend({},this,
a,{B:this})},$:function(a){return this.$el.find(a)},u:!0,initialize:function(a){y(this);e.extend(this,a);this.$el=q(this.el);this.el.view=this;this.b=this.d?this.d.b-1:2E3;this.scope=t(this.render,this.b,this,"view_"+this.Name,this.f,this,!0)},f:function(){},destroy:function(){var a=this;a.l=!0;a.scope.destroy();e.each(a.p||[],function(b){b.destroy(a)});a.destroyDOM(a.$el)},render:function(){var a=this,b,c,d,f,h;if(!a.l){pa++;if(a.q){b=document.activeElement;if(e.contains(q(b).parents(),a.el)){c=
"input";d=e.indexOf(a.$(c),b);try{f=b.selectionStart,h=b.selectionEnd}catch(k){}}b=q("<div>").append(this.$el.children());var g=Ea(a.q,a);a.$el.html(g)}a.ready();a.postReady();g=a.p||[];a.p=na(a.$("[tbone]"),a,g);g=e.difference(g,a.p);e.each(g,function(b){b.destroy(a)});if(a.q&&(a.destroyDOM(b),c&&(c=a.$(c)[d]))&&(q(c).focus(),null!=f&&null!=h))try{c.selectionStart=f,c.selectionEnd=h}catch(l){}Ga++;pa--}},ready:z,postReady:z,destroyDOM:function(){},root:function(){return this.query(1)},query:function(a,
b,c){var d=!1;"number"!==typeof a&&(c=b,b=a,a=0,d=2===arguments.length);b=(this.D?this.D+".":"")+(b||"");return d?this.C(a,b,c):this.C(a,b)},parentRoot:function(){return this.d&&this.d.root()},parent:function(){return this.d},getHashId:function(a){if(!A(a)){var b=k.make();b.query("",a);a=b}if(!a.n){for(var b=[],c=20;c;c--)b.push("0123456789ABCDEF".charAt(Math.floor(16*Math.random())));a.n=b.join("")}Q[a.n]=a;return a.n},isQueryable:A,denullText:R},Fa=/[^\w.]*([\w.]+)[^\w.]+([\w.]+)/g;k.views=P;k.templates=
L;k.createView=function(a,b,c,d){var f=[].slice.call(arguments),h=f.shift();"string"===typeof h?(a=h,h=f.shift()):a="v"+ha++;h&&h.extend?(b=h,h=f.shift()):b=da;"function"===typeof h?(c=h,h=f.shift()):c=null;d=e.extend({},h||{},{Name:a});var k=b.ready;c&&(d.ready=k===z?c:function(){k.call(this);c.call(this)});return P[a]=b.extend(d)};k.setDefaultView=function(a){da=a};k.addTemplate=function(a,b){L[a]=b};k.dontPatch=function(a){ca[a]=!0};k.render=na;k.denullText=R;k.priority={highest:1E4,bound:3E3,
beforeViews:2500,view:2E3,afterViews:1500,async:1E3,lowest:0};P.base=n;try{m.dispatchEvent(new m.CustomEvent("tbone_loaded"))}catch(La){}if(n=m.Backbone){var qa=function(a,b,c){var d=1===a,f=2===a,h=7===a,k=3===arguments.length,g=h||k;"number"!==typeof a&&(c=b,b=a,a=0,2===arguments.length&&(k=g=!0));b=(b||"").replace(/\.?(__self__)?\.?$/,"");var l=b.split("."),m;g&&(m=l[l.length-1]);for(var n,r=d&&!b?this:this.e?this.models:this.attributes,q=[],s=l[0]||"",u=b?r[s]:r,t,v;null!=(t=l.shift());)if(""!==
t)if(q.push(t),n=r,r=r[t],null==r)if(g)r=ba.exec(l[0])?[]:{},n[t]=r;else break;else if(A(r)){v=!0;break}!g&&w&&(q=y(this),w[q]||(w[q]={obj:this,props:{}}),w[q].props[s]=u);if(v&&(!d||l.length))return k?r.query(a,l.join("."),c):r.query(a,l.join("."));if(g){if(null==n)if(this.e)this.reset(null!=c?c:[]);else if(c){for(var x in this.toJSON())void 0===c[x]&&this.unset(x);this.set(c)}else this.clear();else h?c=n[m]=!r:n[m]!==c&&(n[m]=c),s&&this.trigger("change:"+s),this.trigger("change");return c}r&&!f&&
this.e&&""===b&&(r=e.map(r,function(a){return a.query()}));return r},ea=n.Model.extend({h:!0,initialize:function(){var a=this;y(a);var b=(a.a=a.t())?1E3:3E3;ja({execute:function(){a.scope=t(a.update,b,a,"model_"+a.Name,a.f,a)},b:b+5E3})},t:function(){return!!this._url},f:function(){},reset:function(){this.scope&&this.scope.trigger()},isVisible:function(){return fa(this)},update:function(){this.t()?this.M():this.O()},M:function(){function a(){c===b.j&&(v--,delete b.j)}var b=this,c,d=b.url(),e=b.m;
b.a=!this.isVisible();b.a?b.a=!0:null!=d&&d!==e&&(b.m=d,b.clearOnFetch&&b.clear(),b.fetch({dataType:"text",success:function(){b.postFetch();b.trigger("fetch");b.toJSON()},complete:a,beforeSend:function(d){b.j&&(b.j.abort(),a());v++;c=b.j=d},url:d}))},O:function(){this.state&&(this.query("",this.state()),this.toJSON())},state:null,postFetch:z,clearOnFetch:!0});e.each([n.Model.prototype,n.Collection.prototype],function(a){e.extend(a,{isBackbone:!0,query:qa,text:K,lookup:qa,lookupText:K,c:function(a){this.a&&
(this.trigger("wake"),this.a=!1,this.reset());e.each(this.scope&&this.scope.o||[],function(b){(b=b.obj)&&!a[y(b)]&&(a[y(b)]=!0,b.c(a))})}});var b=a.on;a.on=function(){this.c({});return b.apply(this,arguments)}});u=u.bbbase=ea;G=G.bbbase=n.Collection.extend({e:!0});e.each([u,G],function(a){e.extend(a.prototype,{_validate:function(){return!0}})})}k.initAngular=function(a){function b(){d=null;e.each(e.uniq(c),function(a){a.Q()});c=[]}var c=[],d;a.$tbind=function(a,e){var g=this,f=void 0,k=T(function(){2!==
f&&(g[a]=T(e),f=1,"$digest"!==g.$root.$$phase&&(console.log("queue scope digest"),d||(d=setTimeout(b,0)),c.push(g)));f=void 0},2E3);k.$angscope=g;var m=g.$watch(a,function(a){1!==f&&(T(e,a),f=2);f=void 0});g.$tbone||(g.$tbone={bindings:{}});g.$tbone.bindings[a]={G:k,J:m}};a.$tunbind=function(a){var b=this.$tbone.bindings,c=b[a];c.G.destroy();delete c.G.$angscope;c.J();delete b[a]};var f=a.$destroy;a.P=function(){var a=this;a.$tbone&&(e.each(e.keys(a.$tbone.bindings),function(b){a.$tunbind(b)}),delete a.$tbone);
return f.apply(a,arguments)}}})();
